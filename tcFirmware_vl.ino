//  TTTTTTTTTTTTTTTTTTTTTTT     OOOOOOOOO     UUUUUUUU     UUUUUUUU       CCCCCCCCCCCCCHHHHHHHHH     HHHHHHHHH
//  T:::::::::::::::::::::T   OO:::::::::OO   U::::::U     U::::::U    CCC::::::::::::CH:::::::H     H:::::::H
//  T:::::::::::::::::::::T OO:::::::::::::OO U::::::U     U::::::U  CC:::::::::::::::CH:::::::H     H:::::::H
//  T:::::TT:::::::TT:::::TO:::::::OOO:::::::OUU:::::U     U:::::UU C:::::CCCCCCCC::::CHH::::::H     H::::::HH
//  TTTTTT  T:::::T  TTTTTTO::::::O   O::::::O U:::::U     U:::::U C:::::C       CCCCCC  H:::::H     H:::::H  
//          T:::::T        O:::::O     O:::::O U:::::D     D:::::UC:::::C                H:::::H     H:::::H  
//          T:::::T        O:::::O     O:::::O U:::::D     D:::::UC:::::C                H::::::HHHHH::::::H  
//          T:::::T        O:::::O     O:::::O U:::::D     D:::::UC:::::C                H:::::::::::::::::H  
//          T:::::T        O:::::O     O:::::O U:::::D     D:::::UC:::::C                H:::::::::::::::::H  
//          T:::::T        O:::::O     O:::::O U:::::D     D:::::UC:::::C                H::::::HHHHH::::::H  
//          T:::::T        O:::::O     O:::::O U:::::D     D:::::UC:::::C                H:::::H     H:::::H  
//          T:::::T        O::::::O   O::::::O U::::::U   U::::::U C:::::C       CCCCCC  H:::::H     H:::::H  
//        TT:::::::TT      O:::::::OOO:::::::O U:::::::UUU:::::::U  C:::::CCCCCCCC::::CHH::::::H     H::::::HH
//        T:::::::::T       OO:::::::::::::OO   UU:::::::::::::UU    CC:::::::::::::::CH:::::::H     H:::::::H
//        T:::::::::T         OO:::::::::OO       UU:::::::::UU        CCC::::::::::::CH:::::::H     H:::::::H
//        TTTTTTTTTTT           OOOOOOOOO           UUUUUUUUU             CCCCCCCCCCCCCHHHHHHHHH     HHHHHHHHH
//                                                                                                                                                        
//                                                                                                                                                        
//          CCCCCCCCCCCCC     OOOOOOOOO     NNNNNNNN        NNNNNNNNTTTTTTTTTTTTTTTTTTTTTTTRRRRRRRRRRRRRRRRR        OOOOOOOOO     LLLLLLLLLLL             
//       CCC::::::::::::C   OO:::::::::OO   N:::::::N       N::::::NT:::::::::::::::::::::TR::::::::::::::::R     OO:::::::::OO   L:::::::::L             
//     CC:::::::::::::::C OO:::::::::::::OO N::::::::N      N::::::NT:::::::::::::::::::::TR::::::RRRRRR:::::R  OO:::::::::::::OO L:::::::::L             
//    C:::::CCCCCCCC::::CO:::::::OOO:::::::ON:::::::::N     N::::::NT:::::TT:::::::TT:::::TRR:::::R     R:::::RO:::::::OOO:::::::OLL:::::::LL             
//   C:::::C       CCCCCCO::::::O   O::::::ON::::::::::N    N::::::NTTTTTT  T:::::T  TTTTTT  R::::R     R:::::RO::::::O   O::::::O  L:::::L               
//  C:::::C              O:::::O     O:::::ON:::::::::::N   N::::::N        T:::::T          R::::R     R:::::RO:::::O     O:::::O  L:::::L               
//  C:::::C              O:::::O     O:::::ON:::::::N::::N  N::::::N        T:::::T          R::::RRRRRR:::::R O:::::O     O:::::O  L:::::L               
//  C:::::C              O:::::O     O:::::ON::::::N N::::N N::::::N        T:::::T          R:::::::::::::RR  O:::::O     O:::::O  L:::::L               
//  C:::::C              O:::::O     O:::::ON::::::N  N::::N:::::::N        T:::::T          R::::RRRRRR:::::R O:::::O     O:::::O  L:::::L               
//  C:::::C              O:::::O     O:::::ON::::::N   N:::::::::::N        T:::::T          R::::R     R:::::RO:::::O     O:::::O  L:::::L               
//  C:::::C              O:::::O     O:::::ON::::::N    N::::::::::N        T:::::T          R::::R     R:::::RO:::::O     O:::::O  L:::::L               
//   C:::::C       CCCCCCO::::::O   O::::::ON::::::N     N:::::::::N        T:::::T          R::::R     R:::::RO::::::O   O::::::O  L:::::L         LLLLLL
//    C:::::CCCCCCCC::::CO:::::::OOO:::::::ON::::::N      N::::::::N      TT:::::::TT      RR:::::R     R:::::RO:::::::OOO:::::::OLL:::::::LLLLLLLLL:::::L
//     CC:::::::::::::::C OO:::::::::::::OO N::::::N       N:::::::N      T:::::::::T      R::::::R     R:::::R OO:::::::::::::OO L::::::::::::::::::::::L
//       CCC::::::::::::C   OO:::::::::OO   N::::::N        N::::::N      T:::::::::T      R::::::R     R:::::R   OO:::::::::OO   L::::::::::::::::::::::L
//          CCCCCCCCCCCCC     OOOOOOOOO     NNNNNNNN         NNNNNNN      TTTTTTTTTTT      RRRRRRRR     RRRRRRR     OOOOOOOOO     LLLLLLLLLLLLLLLLLLLLLLLL





// -------------------------------------------------------------------------------------------------------------------------------------------------------
// -------------------------------------------------------------------------------------------------------------------------------------------------------
// -------------------------------------------------------------------------------------------------------------------------------------------------------






#include <CapacitiveSensor.h>





// -------------------------------------------------------------------------------------------------------------------------------------------------------
// -------------------------------------------------------------------------------------------------------------------------------------------------------
// -------------------------------------------------------------------------------------------------------------------------------------------------------





//  PPPPPPPPPPPPPPPPP   IIIIIIIIIINNNNNNNN        NNNNNNNN   SSSSSSSSSSSSSSS 
//  P::::::::::::::::P  I::::::::IN:::::::N       N::::::N SS:::::::::::::::S
//  P::::::PPPPPP:::::P I::::::::IN::::::::N      N::::::NS:::::SSSSSS::::::S
//  PP:::::P     P:::::PII::::::IIN:::::::::N     N::::::NS:::::S     SSSSSSS
//    P::::P     P:::::P  I::::I  N::::::::::N    N::::::NS:::::S            
//    P::::P     P:::::P  I::::I  N:::::::::::N   N::::::NS:::::S            
//    P::::PPPPPP:::::P   I::::I  N:::::::N::::N  N::::::N S::::SSSS         
//    P:::::::::::::PP    I::::I  N::::::N N::::N N::::::N  SS::::::SSSSS    
//    P::::PPPPPPPPP      I::::I  N::::::N  N::::N:::::::N    SSS::::::::SS  
//    P::::P              I::::I  N::::::N   N:::::::::::N       SSSSSS::::S 
//    P::::P              I::::I  N::::::N    N::::::::::N            S:::::S
//    P::::P              I::::I  N::::::N     N:::::::::N            S:::::S
//  PP::::::PP          II::::::IIN::::::N      N::::::::NSSSSSSS     S:::::S
//  P::::::::P          I::::::::IN::::::N       N:::::::NS::::::SSSSSS:::::S
//  P::::::::P          I::::::::IN::::::N        N::::::NS:::::::::::::::SS 
//  PPPPPPPPPP          IIIIIIIIIINNNNNNNN         NNNNNNN SSSSSSSSSSSSSSS   

byte switchInput[10] = {44,46,48,50,52,47,45,2,51,49};
byte switchResistor[10] = {25,24,27,26,29,43,42,38,41,40};
byte axisInput[10] = {A2,A1,A3,A0,A4,A5,A9,A6,A8,A7};
byte axisResistor[10] = {30,31,33,28,32,35,39,34,36,37};
byte channelOutput[10] = {7,6,5,4,3,53,14,15,16,17};
byte axisOutput[3] = {11,12,13};

const byte clockInput = 68;
byte resetInput = 69;
byte scanInput = A10;

byte monoButton = 8;
byte restButton = 9;
byte duoButton = 10;

byte gateOutputLeft = 67;
byte gateOutputRight = 66;
byte gateOutputAll = A11;

byte allSelectorA = 18;
byte allSelectorB = 19;
byte allSelectorC = 22;
byte allSelectorD = 23;





// -------------------------------------------------------------------------------------------------------------------------------------------------------
// -------------------------------------------------------------------------------------------------------------------------------------------------------
// -------------------------------------------------------------------------------------------------------------------------------------------------------





//          CCCCCCCCCCCCC               AAA               PPPPPPPPPPPPPPPPP           SSSSSSSSSSSSSSS EEEEEEEEEEEEEEEEEEEEEETTTTTTTTTTTTTTTTTTTTTTTUUUUUUUU     UUUUUUUUPPPPPPPPPPPPPPPPP   
//       CCC::::::::::::C              A:::A              P::::::::::::::::P        SS:::::::::::::::SE::::::::::::::::::::ET:::::::::::::::::::::TU::::::U     U::::::UP::::::::::::::::P  
//     CC:::::::::::::::C             A:::::A             P::::::PPPPPP:::::P      S:::::SSSSSS::::::SE::::::::::::::::::::ET:::::::::::::::::::::TU::::::U     U::::::UP::::::PPPPPP:::::P 
//    C:::::CCCCCCCC::::C            A:::::::A            PP:::::P     P:::::P     S:::::S     SSSSSSSEE::::::EEEEEEEEE::::ET:::::TT:::::::TT:::::TUU:::::U     U:::::UUPP:::::P     P:::::P
//   C:::::C       CCCCCC           A:::::::::A             P::::P     P:::::P     S:::::S              E:::::E       EEEEEETTTTTT  T:::::T  TTTTTT U:::::U     U:::::U   P::::P     P:::::P
//  C:::::C                        A:::::A:::::A            P::::P     P:::::P     S:::::S              E:::::E                     T:::::T         U:::::D     D:::::U   P::::P     P:::::P
//  C:::::C                       A:::::A A:::::A           P::::PPPPPP:::::P       S::::SSSS           E::::::EEEEEEEEEE           T:::::T         U:::::D     D:::::U   P::::PPPPPP:::::P 
//  C:::::C                      A:::::A   A:::::A          P:::::::::::::PP         SS::::::SSSSS      E:::::::::::::::E           T:::::T         U:::::D     D:::::U   P:::::::::::::PP  
//  C:::::C                     A:::::A     A:::::A         P::::PPPPPPPPP             SSS::::::::SS    E:::::::::::::::E           T:::::T         U:::::D     D:::::U   P::::PPPPPPPPP    
//  C:::::C                    A:::::AAAAAAAAA:::::A        P::::P                        SSSSSS::::S   E::::::EEEEEEEEEE           T:::::T         U:::::D     D:::::U   P::::P            
//  C:::::C                   A:::::::::::::::::::::A       P::::P                             S:::::S  E:::::E                     T:::::T         U:::::D     D:::::U   P::::P            
//   C:::::C       CCCCCC    A:::::AAAAAAAAAAAAA:::::A      P::::P                             S:::::S  E:::::E       EEEEEE        T:::::T         U::::::U   U::::::U   P::::P            
//    C:::::CCCCCCCC::::C   A:::::A             A:::::A   PP::::::PP               SSSSSSS     S:::::SEE::::::EEEEEEEE:::::E      TT:::::::TT       U:::::::UUU:::::::U PP::::::PP          
//     CC:::::::::::::::C  A:::::A               A:::::A  P::::::::P               S::::::SSSSSS:::::SE::::::::::::::::::::E      T:::::::::T        UU:::::::::::::UU  P::::::::P          
//       CCC::::::::::::C A:::::A                 A:::::A P::::::::P               S:::::::::::::::SS E::::::::::::::::::::E      T:::::::::T          UU:::::::::UU    P::::::::P          
//          CCCCCCCCCCCCCAAAAAAA                   AAAAAAAPPPPPPPPPP                SSSSSSSSSSSSSSS   EEEEEEEEEEEEEEEEEEEEEE      TTTTTTTTTTT            UUUUUUUUU      PPPPPPPPPP   

// CAPACITIVE SETUP
// ----------------
CapacitiveSensor capSwitch[10] = {CapacitiveSensor(switchResistor[0],switchInput[0]), CapacitiveSensor(switchResistor[1],switchInput[1]), CapacitiveSensor(switchResistor[2],switchInput[2]), CapacitiveSensor(switchResistor[3],switchInput[3]), CapacitiveSensor(switchResistor[4],switchInput[4]), CapacitiveSensor(switchResistor[5],switchInput[5]), CapacitiveSensor(switchResistor[6],switchInput[6]), CapacitiveSensor(switchResistor[7],switchInput[7]), CapacitiveSensor(switchResistor[8],switchInput[8]), CapacitiveSensor(switchResistor[9],switchInput[9])};
CapacitiveSensor capAxis[10] = {CapacitiveSensor(axisResistor[0],axisInput[0]), CapacitiveSensor(axisResistor[1],axisInput[1]), CapacitiveSensor(axisResistor[2],axisInput[2]), CapacitiveSensor(axisResistor[3],axisInput[3]), CapacitiveSensor(axisResistor[4],axisInput[4]), CapacitiveSensor(axisResistor[5],axisInput[5]), CapacitiveSensor(axisResistor[6],axisInput[6]), CapacitiveSensor(axisResistor[7],axisInput[7]), CapacitiveSensor(axisResistor[8],axisInput[8]), CapacitiveSensor(axisResistor[9],axisInput[9])};
bool capSwitchState[10] = {0,0,0,0,0,0,0,0,0,0};
bool capSwitchPressed[10] = {0,0,0,0,0,0,0,0,0,0};
long capSwitchValue[10] = {0,0,0,0,0,0,0,0,0,0};
long capAxisValue[10] = {0,0,0,0,0,0,0,0,0,0};
long capSwitchBuffer[10] = {100,100,100,100,100,100,100,100,100,100};
byte capSwitchCalibrationCounter[10] = {0,0,0,0,0,0,0,0,0,0};
byte activeChannelLeft = 0;
byte activeChannelRight = 5;
byte activeChannelAll = 0;
byte activeTouchChannelAll = 99;
byte activeTouchChannelLeft = 99;
byte activeTouchChannelRight = 99;




// -------------------------------------------------------------------------------------------------------------------------------------------------------
// -------------------------------------------------------------------------------------------------------------------------------------------------------
// -------------------------------------------------------------------------------------------------------------------------------------------------------





//  VVVVVVVV           VVVVVVVV   AAA               RRRRRRRRRRRRRRRRR   IIIIIIIIII
//  V::::::V           V::::::V  A:::A              R::::::::::::::::R  I::::::::I
//  V::::::V           V::::::V A:::::A             R::::::RRRRRR:::::R I::::::::I
//  V::::::V           V::::::VA:::::::A            RR:::::R     R:::::RII::::::II
//   V:::::V           V:::::VA:::::::::A             R::::R     R:::::R  I::::I  
//    V:::::V         V:::::VA:::::A:::::A            R::::R     R:::::R  I::::I  
//     V:::::V       V:::::VA:::::A A:::::A           R::::RRRRRR:::::R   I::::I  
//      V:::::V     V:::::VA:::::A   A:::::A          R:::::::::::::RR    I::::I  
//       V:::::V   V:::::VA:::::A     A:::::A         R::::RRRRRR:::::R   I::::I  
//        V:::::V V:::::VA:::::AAAAAAAAA:::::A        R::::R     R:::::R  I::::I  
//         V:::::V:::::VA:::::::::::::::::::::A       R::::R     R:::::R  I::::I  
//          V:::::::::VA:::::AAAAAAAAAAAAA:::::A      R::::R     R:::::R  I::::I  
//           V:::::::VA:::::A             A:::::A   RR:::::R     R:::::RII::::::II
//            V:::::VA:::::A               A:::::A  R::::::R     R:::::RI::::::::I
//             V:::VA:::::A                 A:::::A R::::::R     R:::::RI::::::::I
//              VVVAAAAAAA                   AAAAAAARRRRRRRR     RRRRRRRIIIIIIIIII

// TOUCH SWITCH ADJUSTMENT
// -----------------------
byte switchSamples = 3;   // LARGER NUMBER PRODUCES CHEANER TRIGGERS ::: SMALLER NUMBER PRODUCES FASTER RESPONSE
int switchThreshold = 400;   // VALUE ABOVE NOISE FLOOR NEEDED TO TRIGGER CHANNEL
byte axisSamples = 3;   // LARGER NUMBER PREVENTS THE Y-AXIS FROM JUMPING AROUND ::: SMALLER NUMBER PRODUCES FASTER RESPONSE
float axisIndividualSmooth = .4;   // SMOOTH THE INDIVIDUAL Y-AXIS PAD READS
float axisSumSmooth = .3;   // SMOOTH THE SUMMED TOUCH VALUE
byte sliderWabbleBuffer = 4;   // MINIMUM DIFFERENCE BETWEEN Y-AXIS CHANNEL READS REMOVES WABBLE
byte touchLowPercent = 15;   // MINIMUM READ PERCENT FOR AN INDIVIDUAL Y-AXIS CHANNEL READ
byte touchLowRead = 40;   // MINIMUM VALUE FOR AN INDIVIDUAL Y-AXIS CHANNEL READ

byte clockDivisionMono = 0;
byte clockDivisionLeft = 0;
byte clockDivisionRight = 0;

byte activeSequenceStepMono = 99;
byte activeSequenceStepLeft = 99;
byte activeSequenceStepRight = 99;

byte clockDivisionStepMono = 99;
byte clockDivisionStepLeft = 99;
byte clockDivisionStepRight = 99;

byte sequenceNotesMono[64] = {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0};
byte sequenceYAxisMono[64] = {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0};
byte sequenceLengthMono = 0;

bool monoNotePressed = 0;
bool monoNotePressedMono = 0;

byte sequenceNotesLeft[64] = {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0};
byte sequenceYAxisLeft[64] = {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0};
byte sequenceLengthLeft = 0;

byte sequenceNotesRight[64] = {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0};
byte sequenceYAxisRight[64] = {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0};
byte sequenceLengthRight = 0;

bool duoNotePressed = 0;
bool duoNotePressedLeft = 0;
bool duoNotePressedRight = 0;

bool monoButtonPressed = 0;
bool restButtonPressed = 0;
bool duoButtonPressed = 0;

byte lastDuoNotePressed = 0;
byte gateLength = 10;

float clockTimer = 0;
float gateTimerLeft = 0;
float gateTimerRight = 0;
float gateTimerAll = 0;

bool noteMode = 0; //  0 = MONO  1 = DUO

byte lastSliderValueLeft = 0;
byte lastSliderValueRight = 0;
volatile bool resetInputUsed = 0;
int capSwitchTimerLength = 25;
float capSwitchTimerLeft = 0;
float lastCapSwitchTimerLeft = 0;
float capSwitchTimerRight= 0;
float lastCapSwitchTimerRight = 0;
bool externalClockResetDisabled = 1;
int touchCounter[10] = {0,0,0,0,0,0,0,0,0,0};

bool clockInputUsed = 0;
//loat clockInputUsedTimer = 0;
volatile bool resetInputTriggered = 0;
volatile bool clockInterruptTriggered = 0;
bool enableSequenceEdit = 0;
float clockInterruptIgnore = 0;
bool resetTriggerUsed = 0;
bool monoButtonState = 0;
bool monoButtonChangeEnabled = 1;
bool duoButtonState = 0;
bool duoButtonChangeEnabled = 1;
int lastActiveSliderValueAll = 0;
int lastActiveSliderValueLeft = 0;
int lastActiveSliderValueRight = 0;

int lastCapAxisValue[10] = {0,0,0,0,0,0,0,0,0,0};

bool clockInputUsedCheckFlag = 0;
float clockInputUsedCheckTimer = 0;
bool gateOutputAllActive = 0;
bool gateOutputLeftActive = 0;
bool gateOutputRightActive = 0;
float leftYAxisCheck = 0;
bool lastYAxisUsed = 0;




// -------------------------------------------------------------------------------------------------------------------------------------------------------
// -------------------------------------------------------------------------------------------------------------------------------------------------------
// -------------------------------------------------------------------------------------------------------------------------------------------------------





void autoCalibrateSwitch(byte z, bool useLed)
{
  capSwitchBuffer[z] = 100;
  capSwitch[z].reset_CS_AutoCal();
    
  if (useLed == 1)
  {
    digitalWrite (channelOutput[0], 0); // TURN OFF LED 5
    digitalWrite (channelOutput[1], 0); // TURN OFF LED 6
    digitalWrite (channelOutput[2], 0); // TURN OFF LED 7
    digitalWrite (channelOutput[3], 0); // TURN OFF LED 8
    digitalWrite (channelOutput[4], 0); // TURN OFF LED 9
    digitalWrite (channelOutput[5], 0); // TURN OFF LED 5
    digitalWrite (channelOutput[6], 0); // TURN OFF LED 6
    digitalWrite (channelOutput[7], 0); // TURN OFF LED 7
    digitalWrite (channelOutput[8], 0); // TURN OFF LED 8
    digitalWrite (channelOutput[9], 0); // TURN OFF LED 9

    digitalWrite (channelOutput[z], 1); // TURN ON CHANNEL LED

    delay(30);
  }
}





// -------------------------------------------------------------------------------------------------------------------------------------------------------
// -------------------------------------------------------------------------------------------------------------------------------------------------------
// -------------------------------------------------------------------------------------------------------------------------------------------------------





//  LLLLLLLLLLL             EEEEEEEEEEEEEEEEEEEEEEFFFFFFFFFFFFFFFFFFFFFFTTTTTTTTTTTTTTTTTTTTTTT                                               
//  L:::::::::L             E::::::::::::::::::::EF::::::::::::::::::::FT:::::::::::::::::::::T                                               
//  L:::::::::L             E::::::::::::::::::::EF::::::::::::::::::::FT:::::::::::::::::::::T                                               
//  LL:::::::LL             EE::::::EEEEEEEEE::::EFF::::::FFFFFFFFF::::FT:::::TT:::::::TT:::::T                                               
//    L:::::L                 E:::::E       EEEEEE  F:::::F       FFFFFFTTTTTT  T:::::T  TTTTTT                                               
//    L:::::L                 E:::::E               F:::::F                     T:::::T                                                       
//    L:::::L                 E::::::EEEEEEEEEE     F::::::FFFFFFFFFF           T:::::T                                                       
//    L:::::L                 E:::::::::::::::E     F:::::::::::::::F           T:::::T                                                       
//    L:::::L                 E:::::::::::::::E     F:::::::::::::::F           T:::::T                                                       
//    L:::::L                 E::::::EEEEEEEEEE     F::::::FFFFFFFFFF           T:::::T                                                       
//    L:::::L                 E:::::E               F:::::F                     T:::::T                                                       
//    L:::::L         LLLLLL  E:::::E       EEEEEE  F:::::F                     T:::::T                                                       
//  LL:::::::LLLLLLLLL:::::LEE::::::EEEEEEEE:::::EFF:::::::FF                 TT:::::::TT                                                     
//  L::::::::::::::::::::::LE::::::::::::::::::::EF::::::::FF                 T:::::::::T                                                     
//  L::::::::::::::::::::::LE::::::::::::::::::::EF::::::::FF                 T:::::::::T                                                     
//  LLLLLLLLLLLLLLLLLLLLLLLLEEEEEEEEEEEEEEEEEEEEEEFFFFFFFFFFF                 TTTTTTTTTTT                                                     
//                                                                                                                                            
//                                                                                                                                       
//     SSSSSSSSSSSSSSS WWWWWWWW                           WWWWWWWWIIIIIIIIIITTTTTTTTTTTTTTTTTTTTTTT       CCCCCCCCCCCCCHHHHHHHHH     HHHHHHHHH
//   SS:::::::::::::::SW::::::W                           W::::::WI::::::::IT:::::::::::::::::::::T    CCC::::::::::::CH:::::::H     H:::::::H
//  S:::::SSSSSS::::::SW::::::W                           W::::::WI::::::::IT:::::::::::::::::::::T  CC:::::::::::::::CH:::::::H     H:::::::H
//  S:::::S     SSSSSSSW::::::W                           W::::::WII::::::IIT:::::TT:::::::TT:::::T C:::::CCCCCCCC::::CHH::::::H     H::::::HH
//  S:::::S             W:::::W           WWWWW           W:::::W   I::::I  TTTTTT  T:::::T  TTTTTTC:::::C       CCCCCC  H:::::H     H:::::H  
//  S:::::S              W:::::W         W:::::W         W:::::W    I::::I          T:::::T       C:::::C                H:::::H     H:::::H  
//   S::::SSSS            W:::::W       W:::::::W       W:::::W     I::::I          T:::::T       C:::::C                H::::::HHHHH::::::H  
//    SS::::::SSSSS        W:::::W     W:::::::::W     W:::::W      I::::I          T:::::T       C:::::C                H:::::::::::::::::H  
//      SSS::::::::SS       W:::::W   W:::::W:::::W   W:::::W       I::::I          T:::::T       C:::::C                H:::::::::::::::::H  
//         SSSSSS::::S       W:::::W W:::::W W:::::W W:::::W        I::::I          T:::::T       C:::::C                H::::::HHHHH::::::H  
//              S:::::S       W:::::W:::::W   W:::::W:::::W         I::::I          T:::::T       C:::::C                H:::::H     H:::::H  
//              S:::::S        W:::::::::W     W:::::::::W          I::::I          T:::::T        C:::::C       CCCCCC  H:::::H     H:::::H  
//  SSSSSSS     S:::::S         W:::::::W       W:::::::W         II::::::II      TT:::::::TT       C:::::CCCCCCCC::::CHH::::::H     H::::::HH
//  S::::::SSSSSS:::::S          W:::::W         W:::::W          I::::::::I      T:::::::::T        CC:::::::::::::::CH:::::::H     H:::::::H
//  S:::::::::::::::SS            W:::W           W:::W           I::::::::I      T:::::::::T          CCC::::::::::::CH:::::::H     H:::::::H
//   SSSSSSSSSSSSSSS               WWW             WWW            IIIIIIIIII      TTTTTTTTTTT             CCCCCCCCCCCCCHHHHHHHHH     HHHHHHHHH

// READ LEFT TOUCH SWITCH
// -----------------------

void checkCapSwitchLeft(byte x)
{
  if ((noteMode == 0 && monoButtonPressed == 0) || (noteMode == 0 && monoButtonPressed == 1 && enableSequenceEdit == 1) || (noteMode == 1 && duoButtonPressed == 0) || (noteMode == 1 && duoButtonPressed == 1 && enableSequenceEdit == 1))
  {
    capSwitchValue[x] = capSwitch[x].capacitiveSensor(switchSamples); // READ CAPACITIVE SWITCH

    if(capSwitchValue[x] < 0) capSwitchValue[x] = 0;

    if (capSwitchValue[x] >= capSwitchBuffer[x] + switchThreshold)  // IF SWITCH IS PRESSED
    {
      if (capSwitchState[x] == 0 && capSwitchPressed[x] == 0) // IF NEWLY PRESSED
      {
        capSwitchState[x] = 1;  // SET CURRENT SWITCH STATE ON
        capSwitchPressed[x] = 1; // FLAG THE KEY AS PRESSED SO IT CAN BE UNPRESSED IF MULTIPLE KEYS ARE PRESSED
        capSwitchTimerLeft = millis();
        touchCounter[x]++;
        capSwitchCalibrationCounter[x] = 0;

        if (noteMode == 0)
        {
          for (byte y = 0; y < 10; y++)
          {
            if (y != x)
            {
              capSwitchState[y] = 0;
              autoCalibrateSwitch(y,0);
            }
          }
        }


        else //if (noteMode == 1)
        {
          for (byte y = 0; y < 5; y++)
          {
            if (y != x)
            {
              capSwitchState[y] = 0;
              autoCalibrateSwitch(y,0);
            }
          }
        }


        // LEFT SWITCH PRESSED
        // -------------------
        if (monoButtonPressed == 0 && restButtonPressed == 0 && duoButtonPressed == 0)
        {
          if ((noteMode == 0 && activeSequenceStepMono == 99) || (noteMode == 1 && activeSequenceStepLeft == 99))
          {
            digitalWrite(channelOutput[0], 0); // TURN OFF LED 0
            digitalWrite(channelOutput[1], 0); // TURN OFF LED 1
            digitalWrite(channelOutput[2], 0); // TURN OFF LED 2
            digitalWrite(channelOutput[3], 0); // TURN OFF LED 3
            digitalWrite(channelOutput[4], 0); // TURN OFF LED 4

            if (noteMode == 0) // MONO MODE
            {
              digitalWrite (channelOutput[5], 0); // TURN OFF LED 5
              digitalWrite (channelOutput[6], 0); // TURN OFF LED 6
              digitalWrite (channelOutput[7], 0); // TURN OFF LED 7
              digitalWrite (channelOutput[8], 0); // TURN OFF LED 8
              digitalWrite (channelOutput[9], 0); // TURN OFF LED 9

              activeChannelLeft = x; // SET ACTIVE LEFT CHANNEL
              activeChannelAll = x; // SET ACTIVE ALL CHANNEL

              digitalWrite(allSelectorA, 0);
              digitalWrite(allSelectorB, 1);
              digitalWrite(allSelectorC, 0);
              digitalWrite(allSelectorD, 1);
            }

            else // if (noteMode == 1) // DUO MODE
            {
              activeChannelLeft = x; // SET ACTIVE LEFT CHANNEL
              activeChannelAll = x; // SET ACTIVE ALL CHANNEL
            }

            if (x == 0) digitalWrite(channelOutput[0], 1); // TURN ON ACTIVE LEFT LED
            else if (x == 1) digitalWrite(channelOutput[1], 1); // TURN ON ACTIVE LEFT LED
            else if (x == 2) digitalWrite(channelOutput[2], 1); // TURN ON ACTIVE LEFT LED
            else if (x == 3) digitalWrite(channelOutput[3], 1); // TURN ON ACTIVE LEFT LED
            else digitalWrite(channelOutput[4], 1); // TURN ON ACTIVE LEFT LED

            gateTimerLeft = 0;
            if (noteMode == 0 || (noteMode == 1 && activeSequenceStepRight == 99)) gateTimerAll = 0;
            if ((noteMode == 0 && activeSequenceStepMono == 99) || (noteMode == 1 && activeSequenceStepLeft == 99))
            {
              if (gateOutputLeftActive == 1)
              {
                digitalWrite(gateOutputLeft, 0);
                delay(1);
              }
              digitalWrite(gateOutputLeft, 1);
              gateOutputLeftActive = 1;

              if (activeSequenceStepRight == 99)
              {
                if (gateOutputAllActive == 1) digitalWrite(gateOutputAll, 0);
                if (gateOutputRightActive == 1) digitalWrite(gateOutputRight, 0);
                if (gateOutputAllActive == 1 || gateOutputRightActive == 1) delay(1);

                digitalWrite(gateOutputAll, 1);
                digitalWrite(gateOutputRight, 0);

                gateOutputAllActive = 1;
                gateOutputRightActive = 1;
              }
            }

            readYAxisLeft();
          }

          else if ((noteMode == 0 && activeSequenceStepMono != 99) || (noteMode == 1 && activeSequenceStepLeft != 99))
          {
            if (noteMode == 0)
            {
              activeTouchChannelAll = x; // SET ACTIVE ALL TOUCH CHANNEL
              activeTouchChannelLeft = 99; // SET ACTIVE ALL TOUCH CHANNEL
            }

            else if (noteMode == 1)
            {
              activeTouchChannelAll = 99; // SET ACTIVE ALL TOUCH CHANNEL
              activeTouchChannelLeft = x; // SET ACTIVE ALL TOUCH CHANNEL
            }

            readYAxisLeft();
          }
        }


        // MONO BUTTON PRESSED
        // ----------------------------------------
        else if (monoButtonPressed == 1 && lastCapSwitchTimerLeft + capSwitchTimerLength < capSwitchTimerLeft)
        {
          if (enableSequenceEdit == 1)
          {
            lastCapSwitchTimerLeft = capSwitchTimerLeft;
            monoNotePressed = 1;

            if (monoNotePressedMono == 0)
            {
              monoNotePressedMono = 1;

              for (byte y = 0; y < 64; y++) // CLEAR MONO SEQUENCES
              {
                sequenceNotesMono[y] = 0;
              }

              activeSequenceStepMono = 99;
              sequenceLengthMono = 0;
            }


            if (sequenceLengthMono < 63)
            {
              if (activeSequenceStepMono == 99)
              {
                activeSequenceStepMono = 88;
                sequenceLengthMono= 0;
                sequenceNotesMono[0] = x;
              }
              else
              {
                sequenceLengthMono++;
                sequenceNotesMono[sequenceLengthMono] = x;
              }
            }
          }
        }



        // REST BUTTON PRESSED
        // ----------------------------------------
        else if (restButtonPressed == 1 && lastCapSwitchTimerLeft + capSwitchTimerLength < capSwitchTimerLeft)
        {
          externalClockResetDisabled = 1;
          lastCapSwitchTimerLeft = capSwitchTimerLeft;
          if (noteMode == 0)
          {
            clockDivisionMono = x;
          }

          else
          {
            clockDivisionLeft = x;
            if (clockDivisionLeft == 4) clockDivisionLeft = 7;
          }
        }



        // DUO BUTTON PRESSED
        // ----------------------------------------
        else if (duoButtonPressed == 1 && lastCapSwitchTimerLeft + capSwitchTimerLength < capSwitchTimerLeft)
        {
          if (enableSequenceEdit == 1)
          {
            lastCapSwitchTimerLeft = capSwitchTimerLeft;
            duoNotePressed = 1;
            lastDuoNotePressed = 0;

            if (duoNotePressedLeft == 0)
            {
              duoNotePressedLeft = 1;

              for (byte y = 0; y < 64; y++) // CLEAR DUO SEQUENCES
              {
                sequenceNotesLeft[y] = 0;
              }

              activeSequenceStepLeft = 99;
              sequenceLengthLeft = 0;
            }

            if (sequenceLengthLeft < 63)
            {
              if (activeSequenceStepLeft == 99)
              {
                activeSequenceStepLeft = 88;
                sequenceLengthLeft = 0;
                sequenceNotesLeft[0] = x;
              }
              else
              {
                sequenceLengthLeft++;
                sequenceNotesLeft[sequenceLengthLeft] = x;
              }
            }
          }
        }
      }

      // KEY ALREADY PRESSED
      // -------------------
      else if (capSwitchState[x] == 1 && capSwitchPressed[x] == 1)
      {
        if ((noteMode == 0 && activeChannelAll == x && activeSequenceStepMono == 99) || (noteMode == 1 && activeChannelLeft == x && activeSequenceStepLeft == 99))
        {
          readYAxisLeft();
        }

        else if ((noteMode == 0 && activeSequenceStepMono != 99) || (noteMode == 1 && activeSequenceStepLeft != 99))
        {
          readYAxisLeft();
        }
      }
    }



    else //if (capSwitchValue[x] < capSwitchBuffer[x] + switchThreshold)  // IF SWITCH IS NOT PRESSED
    {
      capSwitchState[x] = 0;  // SET CURRENT SWITCH STATE OFF
      capSwitchPressed[x] = 0;

      if (noteMode == 0 && activeTouchChannelAll == x) activeTouchChannelAll = 99; // CLEAR ACTIVE ALL TOUCH CHANNEL
      else if (noteMode == 1 && activeTouchChannelLeft == x) activeTouchChannelLeft = 99; // CLEAR ACTIVE LEFT TOUCH CHANNEL
      
      if (noteMode == 0 && activeChannelAll == x)
      {
        digitalWrite(gateOutputLeft, 0);
        digitalWrite(gateOutputAll, 0);
        gateOutputAllActive = 0;
        gateOutputLeftActive = 0;
      }

      else if (noteMode == 1 && activeChannelLeft == x)
      {
        digitalWrite(gateOutputLeft, 0);
        gateOutputLeftActive = 0;
        if (activeSequenceStepRight == 99 && activeChannelAll == x)
        {
          digitalWrite(gateOutputAll, 0);
          gateOutputAllActive = 0;
        }
      }
      
      if (capSwitchCalibrationCounter[x] == 0) capSwitchBuffer[x] = capSwitchValue[x];
      capSwitchCalibrationCounter[x]++;
      if (capSwitchCalibrationCounter[x] > 10) capSwitchCalibrationCounter[x] = 0;
    }
  }
}





// -------------------------------------------------------------------------------------------------------------------------------------------------------
// -------------------------------------------------------------------------------------------------------------------------------------------------------
// -------------------------------------------------------------------------------------------------------------------------------------------------------





//  LLLLLLLLLLL             EEEEEEEEEEEEEEEEEEEEEEFFFFFFFFFFFFFFFFFFFFFFTTTTTTTTTTTTTTTTTTTTTTT                              
//  L:::::::::L             E::::::::::::::::::::EF::::::::::::::::::::FT:::::::::::::::::::::T                              
//  L:::::::::L             E::::::::::::::::::::EF::::::::::::::::::::FT:::::::::::::::::::::T                              
//  LL:::::::LL             EE::::::EEEEEEEEE::::EFF::::::FFFFFFFFF::::FT:::::TT:::::::TT:::::T                              
//    L:::::L                 E:::::E       EEEEEE  F:::::F       FFFFFFTTTTTT  T:::::T  TTTTTT                              
//    L:::::L                 E:::::E               F:::::F                     T:::::T                                      
//    L:::::L                 E::::::EEEEEEEEEE     F::::::FFFFFFFFFF           T:::::T                                      
//    L:::::L                 E:::::::::::::::E     F:::::::::::::::F           T:::::T                                      
//    L:::::L                 E:::::::::::::::E     F:::::::::::::::F           T:::::T                                      
//    L:::::L                 E::::::EEEEEEEEEE     F::::::FFFFFFFFFF           T:::::T                                      
//    L:::::L                 E:::::E               F:::::F                     T:::::T                                      
//    L:::::L         LLLLLL  E:::::E       EEEEEE  F:::::F                     T:::::T                                      
//  LL:::::::LLLLLLLLL:::::LEE::::::EEEEEEEE:::::EFF:::::::FF                 TT:::::::TT                                    
//  L::::::::::::::::::::::LE::::::::::::::::::::EF::::::::FF                 T:::::::::T                                    
//  L::::::::::::::::::::::LE::::::::::::::::::::EF::::::::FF                 T:::::::::T                                    
//  LLLLLLLLLLLLLLLLLLLLLLLLEEEEEEEEEEEEEEEEEEEEEEFFFFFFFFFFF                 TTTTTTTTTTT                                    
//                                                                                                                           
//                                                                                                                          
//  YYYYYYY       YYYYYYY                                AAA               XXXXXXX       XXXXXXXIIIIIIIIII   SSSSSSSSSSSSSSS 
//  Y:::::Y       Y:::::Y                               A:::A              X:::::X       X:::::XI::::::::I SS:::::::::::::::S
//  Y:::::Y       Y:::::Y                              A:::::A             X:::::X       X:::::XI::::::::IS:::::SSSSSS::::::S
//  Y::::::Y     Y::::::Y                             A:::::::A            X::::::X     X::::::XII::::::IIS:::::S     SSSSSSS
//  YYY:::::Y   Y:::::YYY                            A:::::::::A           XXX:::::X   X:::::XXX  I::::I  S:::::S            
//     Y:::::Y Y:::::Y                              A:::::A:::::A             X:::::X X:::::X     I::::I  S:::::S            
//      Y:::::Y:::::Y                              A:::::A A:::::A             X:::::X:::::X      I::::I   S::::SSSS         
//       Y:::::::::Y      ---------------         A:::::A   A:::::A             X:::::::::X       I::::I    SS::::::SSSSS    
//        Y:::::::Y       -:::::::::::::-        A:::::A     A:::::A            X:::::::::X       I::::I      SSS::::::::SS  
//         Y:::::Y        ---------------       A:::::AAAAAAAAA:::::A          X:::::X:::::X      I::::I         SSSSSS::::S 
//         Y:::::Y                             A:::::::::::::::::::::A        X:::::X X:::::X     I::::I              S:::::S
//         Y:::::Y                            A:::::AAAAAAAAAAAAA:::::A    XXX:::::X   X:::::XXX  I::::I              S:::::S
//         Y:::::Y                           A:::::A             A:::::A   X::::::X     X::::::XII::::::IISSSSSSS     S:::::S
//      YYYY:::::YYYY                       A:::::A               A:::::A  X:::::X       X:::::XI::::::::IS::::::SSSSSS:::::S
//      Y:::::::::::Y                      A:::::A                 A:::::A X:::::X       X:::::XI::::::::IS:::::::::::::::SS 
//      YYYYYYYYYYYYY                     AAAAAAA                   AAAAAAAXXXXXXX       XXXXXXXIIIIIIIIII SSSSSSSSSSSSSSS  

// READ LEFT Y-AXIS POSITION VALUES
// --------------------------------
void readYAxisLeft()
{
  int sliderValue = 0;
  float capAxisTotalLeft = 0;
  float capAxisPercent[5] = {0,0,0,0,0};

  // DETERMINE Y-AXIS VALUE
  // ------------------------------
  for (byte y = 0; y < 5; y++) // CYCLE THROUGH All Y-AXIS SENSORS
  {
    stepClock(); // DON'T LET THE CLOCK SHIFT
    lastCapAxisValue[y] = capAxisValue[y];
    if (noteMode == 0) lastCapAxisValue[y+5] = capAxisValue[y];

    capAxisValue[y] = capAxis[y].capacitiveSensor(axisSamples); // READ Y-AXIS CAPACITIVE SENSOR VALUE

    capAxisValue[y] = smooth(capAxisValue[y], axisIndividualSmooth, lastCapAxisValue[y]);
    
    if (capAxisValue[y] < touchLowRead) capAxisValue[y] = 0;
    capAxisTotalLeft = capAxisTotalLeft + capAxisValue[y]; // ADD VALUE TO LEFT TOTAL
  }

  for (byte y = 0; y < 5; y++) // CYCLE THROUGH All Y-AXIS SENSORS
  {
    capAxisPercent[y] = (capAxisValue[y] / capAxisTotalLeft) * 100; // DETERMINE LEFT SENSOR TOUCH PERCENTAGE
    if (capAxisPercent[y] < touchLowPercent) capAxisValue[y] = 0;  // SET LOW PERCENTAGE VALUES TO 0 TO CLEAN UP READINGS
    capAxisTotalLeft = capAxisTotalLeft + capAxisValue[y];  // ADD CLEANED UP VALUE TO LEFT TOTAL
    capAxisPercent[y] = (capAxisValue[y] / capAxisTotalLeft) * 100; // DETERMINE CLEANED UP LEFT SENSOR TOUCH PERCENTAGE
  }




  // DETERMINE LEFT Y-AXIS FINGER POSITION
  // -------------------------------------
  sliderValue = axisLocation (capAxisPercent[1], capAxisPercent[2], capAxisPercent[3], capAxisPercent[4]);
  

  // CLEAN UP Y-AXIS VALUE
  // -------------------------------------
  if (sliderValue > 255) sliderValue = 255;

  if (lastSliderValueLeft == 0 || sliderValue > lastSliderValueLeft + sliderWabbleBuffer || sliderValue < lastSliderValueLeft - sliderWabbleBuffer || lastYAxisUsed == 1)
  {
    sliderValue = smooth(sliderValue, axisSumSmooth, lastSliderValueLeft);
    lastSliderValueLeft = sliderValue;

    if (noteMode == 0) lastActiveSliderValueAll = sliderValue;
    else lastActiveSliderValueLeft = sliderValue;
    lastYAxisUsed = 0;

    // OUTPUT LEFT Y-AXIS
    // ------------------
    if ((noteMode == 0 && activeSequenceStepMono == 99) || (noteMode == 1 && activeSequenceStepLeft == 99))
    {
      analogWrite(axisOutput[0], sliderValue);
      analogWrite(axisOutput[2], sliderValue);
    }

    if (monoButtonPressed == 1) sequenceYAxisMono[sequenceLengthMono] = sliderValue;
    else if (duoButtonPressed == 1) sequenceYAxisLeft[sequenceLengthLeft] = sliderValue;
    else if (monoButtonPressed == 0 && duoButtonPressed == 0)
    {
      if(noteMode == 0 && activeSequenceStepMono < 64) sequenceYAxisMono[activeSequenceStepMono] = sliderValue;
      if(noteMode == 1 && activeSequenceStepLeft < 64) sequenceYAxisLeft[activeSequenceStepLeft] = sliderValue;
    }
  }
}





// -------------------------------------------------------------------------------------------------------------------------------------------------------
// -------------------------------------------------------------------------------------------------------------------------------------------------------
// -------------------------------------------------------------------------------------------------------------------------------------------------------


// DETERMINE LEFT Y-AXIS FINGER POSITION
// -------------------------------------
byte axisLocation (int capAxisPercent1, int capAxisPercent2, int capAxisPercent3, int capAxisPercent4)
{
  float theSliderValue = 0;

  if (capAxisPercent4 > 5)
  {
    theSliderValue = 255;
  }

  // PAD 3 SELECTED
  else if (capAxisPercent3 > 5)
  {
    theSliderValue = 160 + (1.9 * capAxisPercent3);
  }

  // PAD 2 SELECTED
  else if (capAxisPercent2 > 5)
  {
    theSliderValue = 96 + (1.6 * capAxisPercent2);
  }
  
  // PAD 1 SELECTED
  else if (capAxisPercent1 > 5)
  {
    theSliderValue = 1.6 * capAxisPercent1;
  }

  else theSliderValue = 0;

  return theSliderValue;
}




// -------------------------------------------------------------------------------------------------------------------------------------------------------
// -------------------------------------------------------------------------------------------------------------------------------------------------------
// -------------------------------------------------------------------------------------------------------------------------------------------------------






//  RRRRRRRRRRRRRRRRR   IIIIIIIIII      GGGGGGGGGGGGGHHHHHHHHH     HHHHHHHHHTTTTTTTTTTTTTTTTTTTTTTT                                           
//  R::::::::::::::::R  I::::::::I   GGG::::::::::::GH:::::::H     H:::::::HT:::::::::::::::::::::T                                           
//  R::::::RRRRRR:::::R I::::::::I GG:::::::::::::::GH:::::::H     H:::::::HT:::::::::::::::::::::T                                           
//  RR:::::R     R:::::RII::::::IIG:::::GGGGGGGG::::GHH::::::H     H::::::HHT:::::TT:::::::TT:::::T                                           
//    R::::R     R:::::R  I::::I G:::::G       GGGGGG  H:::::H     H:::::H  TTTTTT  T:::::T  TTTTTT                                           
//    R::::R     R:::::R  I::::IG:::::G                H:::::H     H:::::H          T:::::T                                                   
//    R::::RRRRRR:::::R   I::::IG:::::G                H::::::HHHHH::::::H          T:::::T                                                   
//    R:::::::::::::RR    I::::IG:::::G    GGGGGGGGGG  H:::::::::::::::::H          T:::::T                                                   
//    R::::RRRRRR:::::R   I::::IG:::::G    G::::::::G  H:::::::::::::::::H          T:::::T                                                   
//    R::::R     R:::::R  I::::IG:::::G    GGGGG::::G  H::::::HHHHH::::::H          T:::::T                                                   
//    R::::R     R:::::R  I::::IG:::::G        G::::G  H:::::H     H:::::H          T:::::T                                                   
//    R::::R     R:::::R  I::::I G:::::G       G::::G  H:::::H     H:::::H          T:::::T                                                   
//  RR:::::R     R:::::RII::::::IIG:::::GGGGGGGG::::GHH::::::H     H::::::HH      TT:::::::TT                                                 
//  R::::::R     R:::::RI::::::::I GG:::::::::::::::GH:::::::H     H:::::::H      T:::::::::T                                                 
//  R::::::R     R:::::RI::::::::I   GGG::::::GGG:::GH:::::::H     H:::::::H      T:::::::::T                                                 
//  RRRRRRRR     RRRRRRRIIIIIIIIII      GGGGGG   GGGGHHHHHHHHH     HHHHHHHHH      TTTTTTTTTTT                                                 
//                                                                                                                                            
//                                                                                                                                                                                                                                                                                       
//     SSSSSSSSSSSSSSS WWWWWWWW                           WWWWWWWWIIIIIIIIIITTTTTTTTTTTTTTTTTTTTTTT       CCCCCCCCCCCCCHHHHHHHHH     HHHHHHHHH
//   SS:::::::::::::::SW::::::W                           W::::::WI::::::::IT:::::::::::::::::::::T    CCC::::::::::::CH:::::::H     H:::::::H
//  S:::::SSSSSS::::::SW::::::W                           W::::::WI::::::::IT:::::::::::::::::::::T  CC:::::::::::::::CH:::::::H     H:::::::H
//  S:::::S     SSSSSSSW::::::W                           W::::::WII::::::IIT:::::TT:::::::TT:::::T C:::::CCCCCCCC::::CHH::::::H     H::::::HH
//  S:::::S             W:::::W           WWWWW           W:::::W   I::::I  TTTTTT  T:::::T  TTTTTTC:::::C       CCCCCC  H:::::H     H:::::H  
//  S:::::S              W:::::W         W:::::W         W:::::W    I::::I          T:::::T       C:::::C                H:::::H     H:::::H  
//   S::::SSSS            W:::::W       W:::::::W       W:::::W     I::::I          T:::::T       C:::::C                H::::::HHHHH::::::H  
//    SS::::::SSSSS        W:::::W     W:::::::::W     W:::::W      I::::I          T:::::T       C:::::C                H:::::::::::::::::H  
//      SSS::::::::SS       W:::::W   W:::::W:::::W   W:::::W       I::::I          T:::::T       C:::::C                H:::::::::::::::::H  
//         SSSSSS::::S       W:::::W W:::::W W:::::W W:::::W        I::::I          T:::::T       C:::::C                H::::::HHHHH::::::H  
//              S:::::S       W:::::W:::::W   W:::::W:::::W         I::::I          T:::::T       C:::::C                H:::::H     H:::::H  
//              S:::::S        W:::::::::W     W:::::::::W          I::::I          T:::::T        C:::::C       CCCCCC  H:::::H     H:::::H  
//  SSSSSSS     S:::::S         W:::::::W       W:::::::W         II::::::II      TT:::::::TT       C:::::CCCCCCCC::::CHH::::::H     H::::::HH
//  S::::::SSSSSS:::::S          W:::::W         W:::::W          I::::::::I      T:::::::::T        CC:::::::::::::::CH:::::::H     H:::::::H
//  S:::::::::::::::SS            W:::W           W:::W           I::::::::I      T:::::::::T          CCC::::::::::::CH:::::::H     H:::::::H
//   SSSSSSSSSSSSSSS               WWW             WWW            IIIIIIIIII      TTTTTTTTTTT             CCCCCCCCCCCCCHHHHHHHHH     HHHHHHHHH





// READ RIGHT TOUCH SWITCH
// -----------------------

void checkCapSwitchRight(byte x)
{
  if ((noteMode == 0 && monoButtonPressed == 0) || (noteMode == 0 && monoButtonPressed == 1 && enableSequenceEdit == 1) || (noteMode == 1 && duoButtonPressed == 0) || (noteMode == 1 && duoButtonPressed == 1 && enableSequenceEdit == 1))
  {
    capSwitchValue[x+5] = capSwitch[x+5].capacitiveSensor(switchSamples); // READ CAPACITIVE SWITCH

    if(capSwitchValue[x+5] < 0) capSwitchValue[x+5] = 0;

    if (capSwitchValue[x+5] >= capSwitchBuffer[x+5] + switchThreshold)  // IF SWITCH IS PRESSED
    {
      if (capSwitchState[x+5] == 0 && capSwitchPressed[x+5] == 0) // IF NEWLY PRESSED
      {
        capSwitchState[x+5] = 1;  // SET CURRENT SWITCH STATE ON
        capSwitchPressed[x+5] = 1; // FLAG THE KEY AS PRESSED SO IT CAN BE UNPRESSED IF MULTIPLE KEYS ARE PRESSED
        capSwitchTimerRight = millis();
        touchCounter[x+5]++;
        capSwitchCalibrationCounter[x+5] = 0;

        if (noteMode == 0)
        {
           for (byte y = 0; y < 10; y++)
          {
            if (y != x+5)
            {
              capSwitchState[y] = 0;
              autoCalibrateSwitch(y,0);
            }
          }
        }

        else //if (noteMode == 1)
        {
          for (byte y = 5; y < 10; y++)
          {
            if (y != x+5)
            {
              capSwitchState[y] = 0;
              autoCalibrateSwitch(y,0);
            }
          }
        }


        // RIGHT SWITCH PRESSED
        // -------------------
        if (monoButtonPressed == 0 && restButtonPressed == 0 && duoButtonPressed == 0)
        {
          if ((noteMode == 0 && activeSequenceStepMono == 99) || (noteMode == 1 && activeSequenceStepRight == 99))
          {
            digitalWrite(channelOutput[5], 0); // TURN OFF LED 5
            digitalWrite(channelOutput[6], 0); // TURN OFF LED 6
            digitalWrite(channelOutput[7], 0); // TURN OFF LED 7
            digitalWrite(channelOutput[8], 0); // TURN OFF LED 8
            digitalWrite(channelOutput[9], 0); // TURN OFF LED 9

            if (noteMode == 0) // MONO MODE
            {
              digitalWrite (channelOutput[0], 0); // TURN OFF LED 0
              digitalWrite (channelOutput[1], 0); // TURN OFF LED 1
              digitalWrite (channelOutput[2], 0); // TURN OFF LED 2
              digitalWrite (channelOutput[3], 0); // TURN OFF LED 3
              digitalWrite (channelOutput[4], 0); // TURN OFF LED 4

              activeChannelRight = x+5; // SET ACTIVE RIGHT CHANNEL
              activeChannelAll = x+5; // SET ACTIVE ALL CHANNEL

              digitalWrite(allSelectorA, 1);
              digitalWrite(allSelectorB, 0);
              digitalWrite(allSelectorC, 1);
              digitalWrite(allSelectorD, 0);
            }

            else // if (noteMode == 1) // DUO MODE
            {
              activeChannelRight = x+5; // SET ACTIVE RIGHT CHANNEL
              activeChannelAll = x+5; // SET ACTIVE ALL CHANNEL
            }

            if (x == 0) digitalWrite(channelOutput[5], 1); // TURN ON ACTIVE RIGHT LED
            else if (x == 1) digitalWrite(channelOutput[6], 1); // TURN ON ACTIVE RIGHT LED
            else if (x == 2) digitalWrite(channelOutput[7], 1); // TURN ON ACTIVE RIGHT LED
            else if (x == 3) digitalWrite(channelOutput[8], 1); // TURN ON ACTIVE RIGHT LED
            else digitalWrite(channelOutput[9], 1); // TURN ON ACTIVE RIGHT LED

            gateTimerRight = 0;
            if (noteMode == 0 || (noteMode == 1 && activeSequenceStepLeft == 99)) gateTimerAll = 0;
            if ((noteMode == 0 && activeSequenceStepMono == 99) || (noteMode == 1 && activeSequenceStepRight == 99))
            {
              if (gateOutputRightActive == 1)
              {
                digitalWrite(gateOutputRight, 0);
                delay(1);
              }

              digitalWrite(gateOutputRight, 1);
              gateOutputRightActive = 1;

              if (activeSequenceStepLeft == 99)
              {
                if (gateOutputAllActive == 1)
                {
                  digitalWrite(gateOutputAll, 0);
                  delay(1);
                }

                digitalWrite(gateOutputAll, 1);
                digitalWrite(gateOutputLeft, 0);
                gateOutputAllActive = 1;
                gateOutputLeftActive = 0;
              }
            }

            readYAxisRight();
          }

          else if ((noteMode == 0 && activeSequenceStepMono != 99) || (noteMode == 1 && activeSequenceStepRight != 99))
          {
            if (noteMode == 0)
            {
              activeTouchChannelAll = x+5; // SET ACTIVE ALL TOUCH CHANNEL
              activeTouchChannelRight = 99; // SET ACTIVE ALL TOUCH CHANNEL
            }

            else if (noteMode == 1)
            {
              activeTouchChannelAll = 99; // SET ACTIVE ALL TOUCH CHANNEL
              activeTouchChannelRight = x+5; // SET ACTIVE ALL TOUCH CHANNEL
            }

            readYAxisRight();
          }
        }


        // MONO BUTTON PRESSED
        // ----------------------------------------
        else if (monoButtonPressed == 1 && lastCapSwitchTimerRight + capSwitchTimerLength < capSwitchTimerRight)
        {
          if (enableSequenceEdit == 1)
          {
            lastCapSwitchTimerRight = capSwitchTimerRight;
            monoNotePressed = 1;

            if (monoNotePressedMono == 0)
            {
              monoNotePressedMono = 1;

              for (byte y = 0; y < 64; y++) // CLEAR MONO SEQUENCES
              {
                sequenceNotesMono[y] = 0;
              }

              activeSequenceStepMono = 99;
              sequenceLengthMono = 0;
            }

            if (sequenceLengthMono < 63)
            {
              if (activeSequenceStepMono == 99)
              {
                activeSequenceStepMono = 88;
                sequenceLengthMono= 0;
                sequenceNotesMono[0] = x+5;
              }
              else
              {
                sequenceLengthMono++;
                sequenceNotesMono[sequenceLengthMono] = x+5;
              }
            }
          }
        }


        // REST BUTTON PRESSED
        // ----------------------------------------
        else if (restButtonPressed == 1 && lastCapSwitchTimerRight + capSwitchTimerLength < capSwitchTimerRight)
        {
          externalClockResetDisabled = 1;
          lastCapSwitchTimerRight = capSwitchTimerRight;
          if (noteMode == 0)
          {
            clockDivisionMono = x+5;
          }

          else
          {
            clockDivisionRight = x;
            if (clockDivisionRight == 4) clockDivisionRight = 7;
          }
        }


        // DUO BUTTON PRESSED
        // ----------------------------------------
        else if (duoButtonPressed == 1 && lastCapSwitchTimerRight + capSwitchTimerLength < capSwitchTimerRight)
        {
          if (enableSequenceEdit == 1)
          {
            lastCapSwitchTimerRight = capSwitchTimerRight;
            duoNotePressed = 1;
            lastDuoNotePressed = 1;

            if (duoNotePressedRight == 0)
            {
              duoNotePressedRight = 1;

              for (byte y = 0; y < 64; y++) // CLEAR DUO SEQUENCES
              {
                sequenceNotesRight[y] = 0;
              }

              activeSequenceStepRight = 99;
              sequenceLengthRight = 0;
            }

            if (sequenceLengthRight < 63)
            {
              if (activeSequenceStepRight == 99)
              {
                activeSequenceStepRight = 88;
                sequenceLengthRight = 0;
                sequenceNotesRight[0] = x+5;
              }
              else
              {
                sequenceLengthRight++;
                sequenceNotesRight[sequenceLengthRight] = x+5;
              }
            }
          }
        }
      }

      // KEY ALREADY PRESSED
      // -------------------
      else if (capSwitchState[x+5] == 1 && capSwitchPressed[x+5] == 1)
      {
        if ((noteMode == 0 && activeChannelAll == x+5 && activeSequenceStepMono == 99) || (noteMode == 1 && activeChannelRight == x+5 && activeSequenceStepRight == 99))
        {
          readYAxisRight();
        }
        
        else if ((noteMode == 0 && activeSequenceStepMono != 99) || (noteMode == 1 && activeSequenceStepRight != 99))
        {
          readYAxisRight();
        }
      }
    }

    else //if (capSwitchValue[x+5] < capSwitchBuffer[x+5] + switchThreshold)  // IF SWITCH IS NOT PRESSED
    {
      capSwitchState[x+5] = 0;
      capSwitchPressed[x+5] = 0;

      if (noteMode == 0 && activeTouchChannelAll == x+5) activeTouchChannelAll = 99; // CLEAR ACTIVE ALL TOUCH CHANNEL
      else if (noteMode == 1 && activeTouchChannelRight == x+5) activeTouchChannelRight = 99; // CLEAR ACTIVE LEFT TOUCH CHANNEL

      if (noteMode == 0 && activeChannelAll == x+5)
      {
        digitalWrite(gateOutputRight, 0);
        digitalWrite(gateOutputAll, 0);
        gateOutputAllActive = 0;
        gateOutputRightActive = 0;
      }
      else if (noteMode == 1 && activeChannelRight == x+5)
      {
        digitalWrite(gateOutputRight, 0);
        gateOutputRightActive = 0;
        if (activeSequenceStepLeft == 99 && activeChannelAll == x+5)
        {
          digitalWrite(gateOutputAll, 0);
          gateOutputAllActive = 0;
        }
      }
      
      if (capSwitchCalibrationCounter[x+5] == 0) capSwitchBuffer[x+5] = capSwitchValue[x+5];
      capSwitchCalibrationCounter[x+5]++;
      if (capSwitchCalibrationCounter[x+5] > 10) capSwitchCalibrationCounter[x+5] = 0;
    }
  }
}






// -------------------------------------------------------------------------------------------------------------------------------------------------------
// -------------------------------------------------------------------------------------------------------------------------------------------------------
// -------------------------------------------------------------------------------------------------------------------------------------------------------





//  RRRRRRRRRRRRRRRRR   IIIIIIIIII      GGGGGGGGGGGGGHHHHHHHHH     HHHHHHHHHTTTTTTTTTTTTTTTTTTTTTTT                          
//  R::::::::::::::::R  I::::::::I   GGG::::::::::::GH:::::::H     H:::::::HT:::::::::::::::::::::T                          
//  R::::::RRRRRR:::::R I::::::::I GG:::::::::::::::GH:::::::H     H:::::::HT:::::::::::::::::::::T                          
//  RR:::::R     R:::::RII::::::IIG:::::GGGGGGGG::::GHH::::::H     H::::::HHT:::::TT:::::::TT:::::T                          
//    R::::R     R:::::R  I::::I G:::::G       GGGGGG  H:::::H     H:::::H  TTTTTT  T:::::T  TTTTTT                          
//    R::::R     R:::::R  I::::IG:::::G                H:::::H     H:::::H          T:::::T                                  
//    R::::RRRRRR:::::R   I::::IG:::::G                H::::::HHHHH::::::H          T:::::T                                  
//    R:::::::::::::RR    I::::IG:::::G    GGGGGGGGGG  H:::::::::::::::::H          T:::::T                                  
//    R::::RRRRRR:::::R   I::::IG:::::G    G::::::::G  H:::::::::::::::::H          T:::::T                                  
//    R::::R     R:::::R  I::::IG:::::G    GGGGG::::G  H::::::HHHHH::::::H          T:::::T                                  
//    R::::R     R:::::R  I::::IG:::::G        G::::G  H:::::H     H:::::H          T:::::T                                  
//    R::::R     R:::::R  I::::I G:::::G       G::::G  H:::::H     H:::::H          T:::::T                                  
//  RR:::::R     R:::::RII::::::IIG:::::GGGGGGGG::::GHH::::::H     H::::::HH      TT:::::::TT                                
//  R::::::R     R:::::RI::::::::I GG:::::::::::::::GH:::::::H     H:::::::H      T:::::::::T                                
//  R::::::R     R:::::RI::::::::I   GGG::::::GGG:::GH:::::::H     H:::::::H      T:::::::::T                                
//  RRRRRRRR     RRRRRRRIIIIIIIIII      GGGGGG   GGGGHHHHHHHHH     HHHHHHHHH      TTTTTTTTTTT                                
//                                                                                                                                                                                                                                                   
//                                                                                                                           
//  YYYYYYY       YYYYYYY                                AAA               XXXXXXX       XXXXXXXIIIIIIIIII   SSSSSSSSSSSSSSS 
//  Y:::::Y       Y:::::Y                               A:::A              X:::::X       X:::::XI::::::::I SS:::::::::::::::S
//  Y:::::Y       Y:::::Y                              A:::::A             X:::::X       X:::::XI::::::::IS:::::SSSSSS::::::S
//  Y::::::Y     Y::::::Y                             A:::::::A            X::::::X     X::::::XII::::::IIS:::::S     SSSSSSS
//  YYY:::::Y   Y:::::YYY                            A:::::::::A           XXX:::::X   X:::::XXX  I::::I  S:::::S            
//     Y:::::Y Y:::::Y                              A:::::A:::::A             X:::::X X:::::X     I::::I  S:::::S            
//      Y:::::Y:::::Y                              A:::::A A:::::A             X:::::X:::::X      I::::I   S::::SSSS         
//       Y:::::::::Y      ---------------         A:::::A   A:::::A             X:::::::::X       I::::I    SS::::::SSSSS    
//        Y:::::::Y       -:::::::::::::-        A:::::A     A:::::A            X:::::::::X       I::::I      SSS::::::::SS  
//         Y:::::Y        ---------------       A:::::AAAAAAAAA:::::A          X:::::X:::::X      I::::I         SSSSSS::::S 
//         Y:::::Y                             A:::::::::::::::::::::A        X:::::X X:::::X     I::::I              S:::::S
//         Y:::::Y                            A:::::AAAAAAAAAAAAA:::::A    XXX:::::X   X:::::XXX  I::::I              S:::::S
//         Y:::::Y                           A:::::A             A:::::A   X::::::X     X::::::XII::::::IISSSSSSS     S:::::S
//      YYYY:::::YYYY                       A:::::A               A:::::A  X:::::X       X:::::XI::::::::IS::::::SSSSSS:::::S
//      Y:::::::::::Y                      A:::::A                 A:::::A X:::::X       X:::::XI::::::::IS:::::::::::::::SS 
//      YYYYYYYYYYYYY                     AAAAAAA                   AAAAAAAXXXXXXX       XXXXXXXIIIIIIIIII SSSSSSSSSSSSSSS  





// READ RIGHT Y-AXIS POSITION VALUES
// ---------------------------------

void readYAxisRight()
{
  int sliderValue = 0;
  float capAxisTotalRight = 0;
  float capAxisPercent[5] = {0,0,0,0,0};// DOUBLE CHECK KEY IS PRESSED

  // DETERMINE Y-AXIS VALUE
  // ------------------------------
  for (byte y = 5; y < 10; y++) // CYCLE THROUGH All Y-AXIS SENSORS
  {
    stepClock(); // DON'T LET THE CLOCK SHIFT
    lastCapAxisValue[y] = capAxisValue[y];
    if (noteMode == 0) lastCapAxisValue[y-5] = capAxisValue[y];
    capAxisValue[y] = capAxis[y].capacitiveSensor(axisSamples); // READ Y-AXIS CAPACITIVE SENSOR VALUE

    capAxisValue[y] = smooth(capAxisValue[y], axisIndividualSmooth, lastCapAxisValue[y]);

    if (capAxisValue[y] < touchLowRead) capAxisValue[y] = 0;
    capAxisTotalRight = capAxisTotalRight + capAxisValue[y]; // ADD VALUE TO LEFT TOTAL
  }


  for (byte y = 5; y < 10; y++) // CYCLE THROUGH All Y-AXIS SENSORS
  {
    capAxisPercent[y-5] = (capAxisValue[y] / capAxisTotalRight) * 100; // DETERMINE LEFT SENSOR TOUCH PERCENTAGE
    if (capAxisPercent[y-5] < touchLowPercent) capAxisValue[y] = 0;  // SET LOW PERCENTAGE VALUES TO 0 TO CLEAN UP READINGS
    capAxisTotalRight = capAxisTotalRight + capAxisValue[y];  // ADD CLEANED UP VALUE TO LEFT TOTAL
    capAxisPercent[y-5] = (capAxisValue[y] / capAxisTotalRight) * 100; // DETERMINE CLEANED UP LEFT SENSOR TOUCH PERCENTAGE
  }
  

  // DETERMINE RIGHT Y-AXIS FINGER POSITION
  // -------------------------------------
  sliderValue = axisLocation (capAxisPercent[1], capAxisPercent[2], capAxisPercent[3], capAxisPercent[4]);
  
  
  // CLEAN UP Y-AXIS VALUE
  // -------------------------------------
  if (sliderValue > 255) sliderValue = 255;

  if (lastSliderValueRight == 0 || sliderValue > lastSliderValueRight + sliderWabbleBuffer || sliderValue < lastSliderValueRight - sliderWabbleBuffer || lastYAxisUsed == 0)
  {
    sliderValue = smooth(sliderValue, axisSumSmooth, lastSliderValueRight);
    lastSliderValueRight = sliderValue;
    
    if (noteMode == 0) lastActiveSliderValueAll = sliderValue;
    else lastActiveSliderValueRight = sliderValue;
    lastYAxisUsed = 1;

    // OUTPUT RIGHT Y-AXIS
    // ------------------
    if ((noteMode == 0 && activeSequenceStepMono == 99) || (noteMode == 1 && activeSequenceStepRight == 99))
    {
      analogWrite(axisOutput[1], sliderValue);
      analogWrite(axisOutput[2], sliderValue);
    }
  }

  if (monoButtonPressed == 1) sequenceYAxisMono[sequenceLengthMono] = sliderValue;
  else if (duoButtonPressed == 1) sequenceYAxisRight[sequenceLengthRight] = sliderValue;
  else if (monoButtonPressed == 0 && duoButtonPressed == 0)
  {
    if(noteMode == 0 && activeSequenceStepMono < 64) sequenceYAxisMono[activeSequenceStepMono] = sliderValue;
    if(noteMode == 1 && activeSequenceStepRight < 64) sequenceYAxisRight[activeSequenceStepRight] = sliderValue;
  }
}






// -------------------------------------------------------------------------------------------------------------------------------------------------------
// -------------------------------------------------------------------------------------------------------------------------------------------------------
// -------------------------------------------------------------------------------------------------------------------------------------------------------






int smooth(int data, float filterVal, float smoothedVal)
{
  // check to make sure param's are within range
  //if (filterVal > 1) filterVal = .99;
  //if (filterVal <= 0) filterVal = 0;

  smoothedVal = (data * (1 - filterVal)) + (smoothedVal  *  filterVal);
  return (int)smoothedVal;
}





// -------------------------------------------------------------------------------------------------------------------------------------------------------
// -------------------------------------------------------------------------------------------------------------------------------------------------------
// -------------------------------------------------------------------------------------------------------------------------------------------------------









// -------------------------------------------------------------------------------------------------------------------------------------------------------
// -------------------------------------------------------------------------------------------------------------------------------------------------------
// -------------------------------------------------------------------------------------------------------------------------------------------------------





//          CCCCCCCCCCCCCLLLLLLLLLLL                  OOOOOOOOO             CCCCCCCCCCCCCKKKKKKKKK    KKKKKKK     IIIIIIIIIINNNNNNNN        NNNNNNNN
//       CCC::::::::::::CL:::::::::L                OO:::::::::OO        CCC::::::::::::CK:::::::K    K:::::K     I::::::::IN:::::::N       N::::::N
//     CC:::::::::::::::CL:::::::::L              OO:::::::::::::OO    CC:::::::::::::::CK:::::::K    K:::::K     I::::::::IN::::::::N      N::::::N
//    C:::::CCCCCCCC::::CLL:::::::LL             O:::::::OOO:::::::O  C:::::CCCCCCCC::::CK:::::::K   K::::::K     II::::::IIN:::::::::N     N::::::N
//   C:::::C       CCCCCC  L:::::L               O::::::O   O::::::O C:::::C       CCCCCCKK::::::K  K:::::KKK       I::::I  N::::::::::N    N::::::N
//  C:::::C                L:::::L               O:::::O     O:::::OC:::::C                K:::::K K:::::K          I::::I  N:::::::::::N   N::::::N
//  C:::::C                L:::::L               O:::::O     O:::::OC:::::C                K::::::K:::::K           I::::I  N:::::::N::::N  N::::::N
//  C:::::C                L:::::L               O:::::O     O:::::OC:::::C                K:::::::::::K            I::::I  N::::::N N::::N N::::::N
//  C:::::C                L:::::L               O:::::O     O:::::OC:::::C                K:::::::::::K            I::::I  N::::::N  N::::N:::::::N
//  C:::::C                L:::::L               O:::::O     O:::::OC:::::C                K::::::K:::::K           I::::I  N::::::N   N:::::::::::N
//  C:::::C                L:::::L               O:::::O     O:::::OC:::::C                K:::::K K:::::K          I::::I  N::::::N    N::::::::::N
//   C:::::C       CCCCCC  L:::::L         LLLLLLO::::::O   O::::::O C:::::C       CCCCCCKK::::::K  K:::::KKK       I::::I  N::::::N     N:::::::::N
//    C:::::CCCCCCCC::::CLL:::::::LLLLLLLLL:::::LO:::::::OOO:::::::O  C:::::CCCCCCCC::::CK:::::::K   K::::::K     II::::::IIN::::::N      N::::::::N
//     CC:::::::::::::::CL::::::::::::::::::::::L OO:::::::::::::OO    CC:::::::::::::::CK:::::::K    K:::::K     I::::::::IN::::::N       N:::::::N
//       CCC::::::::::::CL::::::::::::::::::::::L   OO:::::::::OO        CCC::::::::::::CK:::::::K    K:::::K     I::::::::IN::::::N        N::::::N
//          CCCCCCCCCCCCCLLLLLLLLLLLLLLLLLLLLLLLL     OOOOOOOOO             CCCCCCCCCCCCCKKKKKKKKK    KKKKKKK     IIIIIIIIIINNNNNNNN         NNNNNNN

void clockInterrupted()
{
  clockInterruptTriggered = 1;
}

void clockClosing()
{
  clockInputUsed = 0;
}




void turnOffGates()
{
  clockTimer = millis();

  // TURN OFF GATE OUTPUTS
  // ----------------------------------
  if(gateTimerLeft != 0 && gateTimerLeft < clockTimer)
  {
    gateTimerLeft = 0;
    digitalWrite(gateOutputLeft, 0);
    gateOutputLeftActive = 0;
  }

  if(gateTimerRight != 0 && gateTimerRight < clockTimer)
  {
    gateTimerRight = 0;
    digitalWrite(gateOutputRight, 0);
    gateOutputRightActive = 0;
  }

  if(gateTimerAll != 0 && gateTimerAll < clockTimer)
  {
    gateTimerAll = 0;
    digitalWrite(gateOutputAll, 0);
    gateOutputAllActive = 0;
  }
}




void stepClock()
{
  turnOffGates();

  // CHECK FOR RESET
  // ----------------------------------
  if (resetInputTriggered == 1)
  {
    resetInputTriggered = 0;
    resetTriggerUsed = 1;

    if (activeSequenceStepMono != 99) activeSequenceStepMono = 88;
    if (activeSequenceStepLeft != 99) activeSequenceStepLeft = 88;
    if (activeSequenceStepRight != 99) activeSequenceStepRight = 88;

    clockDivisionStepMono = 99;
    clockDivisionStepLeft = 99;
    clockDivisionStepRight = 99;
  }



  if (clockInterruptTriggered == 1)
  {
    clockInterruptTriggered = 0;
    if (clockInputUsed == 0)
    {
      clockInputUsed = 1;

      // ADVANCE MONO SEQUENCE
      // ----------------------------------
      if (noteMode == 0)
      {
        clockDivisionStepMono++;
        if (clockDivisionStepMono > clockDivisionMono) clockDivisionStepMono = 0;

        if (clockDivisionStepMono == 0)
        {
          //MONO SEQUENCE
          // ----------------
          if (activeSequenceStepMono != 99)
          {
            activeSequenceStepMono++;
            if (activeSequenceStepMono > sequenceLengthMono) activeSequenceStepMono = 0;

            if (sequenceNotesMono[activeSequenceStepMono] != 99) // NOTE NOT MUTED
            {
              activeChannelAll = sequenceNotesMono[activeSequenceStepMono]; // SET ACTIVE MONO CHANNEL
              if (activeChannelAll < 5) activeChannelLeft = activeChannelAll;
              else activeChannelRight = activeChannelAll;
              

              digitalWrite (channelOutput[0], 0); // TURN OFF LED 0
              digitalWrite (channelOutput[1], 0); // TURN OFF LED 1
              digitalWrite (channelOutput[2], 0); // TURN OFF LED 2
              digitalWrite (channelOutput[3], 0); // TURN OFF LED 3
              digitalWrite (channelOutput[4], 0); // TURN OFF LED 4
              digitalWrite (channelOutput[5], 0); // TURN OFF LED 5
              digitalWrite (channelOutput[6], 0); // TURN OFF LED 6
              digitalWrite (channelOutput[7], 0); // TURN OFF LED 7
              digitalWrite (channelOutput[8], 0); // TURN OFF LED 8
              digitalWrite (channelOutput[9], 0); // TURN OFF LED 9

              if(activeChannelAll < 5)
              {
                digitalWrite(allSelectorA, 0);
                digitalWrite(allSelectorB, 1);
                digitalWrite(allSelectorC, 0);
                digitalWrite(allSelectorD, 1);
              }

              else
              {
                digitalWrite(allSelectorA, 1);
                digitalWrite(allSelectorB, 0);
                digitalWrite(allSelectorC, 1);
                digitalWrite(allSelectorD, 0);
              }

              if (activeChannelAll == 0) digitalWrite (channelOutput[0], 1); // TURN ON LED 0
              else if (activeChannelAll == 1) digitalWrite (channelOutput[1], 1); // TURN ON LED 1
              else if (activeChannelAll == 2) digitalWrite (channelOutput[2], 1); // TURN ON LED 2
              else if (activeChannelAll == 3) digitalWrite (channelOutput[3], 1); // TURN ON LED 3
              else if (activeChannelAll == 4) digitalWrite (channelOutput[4], 1); // TURN ON LED 4
              else if (activeChannelAll == 5) digitalWrite (channelOutput[5], 1); // TURN ON LED 5
              else if (activeChannelAll == 6) digitalWrite (channelOutput[6], 1); // TURN ON LED 6
              else if (activeChannelAll == 7) digitalWrite (channelOutput[7], 1); // TURN ON LED 7
              else if (activeChannelAll == 8) digitalWrite (channelOutput[8], 1); // TURN ON LED 8
              else if (activeChannelAll == 9) digitalWrite (channelOutput[9], 1); // TURN ON LED 9

              float readTime = millis();

              if (activeTouchChannelAll != 99) sequenceYAxisMono[activeSequenceStepMono] = lastActiveSliderValueAll;

              if (activeChannelAll < 5) // LEFT
              {
                analogWrite(axisOutput[0], sequenceYAxisMono[activeSequenceStepMono]); // UPDATE Y-AXIS OUT LEFT
                analogWrite(axisOutput[1], 0); // UPDATE Y-AXIS OUT RIGHT
                analogWrite(axisOutput[2], sequenceYAxisMono[activeSequenceStepMono]); // UPDATE Y-AXIS OUT ALL

                gateTimerLeft = gateLength + readTime;
                if (gateOutputLeftActive == 1)
                {
                  digitalWrite(gateOutputLeft, 0);
                  delay(1);
                }
                digitalWrite(gateOutputLeft, 1); // ENABLE LEFT GATE
                gateOutputLeftActive = 1;
              }

              else /// RIGHT
              {
                analogWrite(axisOutput[0], 0); // UPDATE Y-AXIS OUT LEFT
                analogWrite(axisOutput[1], sequenceYAxisMono[activeSequenceStepMono]); // UPDATE Y-AXIS OUT RIGHT
                analogWrite(axisOutput[2], sequenceYAxisMono[activeSequenceStepMono]); // UPDATE Y-AXIS OUT ALL

                gateTimerRight = gateLength + readTime;
                if (gateOutputRightActive == 1)
                {
                  digitalWrite(gateOutputRight, 0);
                  delay(1);
                }
                digitalWrite(gateOutputRight, 1); // ENABLE RIGHT GATE
                gateOutputRightActive = 1;
              }

              gateTimerAll = gateLength + readTime;
              if (gateOutputAllActive == 1)
              {
                digitalWrite(gateOutputAll, 0);
                delay(1);
              }
              digitalWrite(gateOutputAll, 1); // ENABLE ALL GATE
              gateOutputAllActive = 1;
            }
          }
        }
      }
      
      



      // ADVANCE DUO SEQUENCE LEFT
      // ----------------------------------
      else if (noteMode == 1)
      {
        clockDivisionStepLeft++;
        if (clockDivisionStepLeft > clockDivisionLeft) clockDivisionStepLeft = 0;

        bool leftUsed = 0;
        bool rightUsed = 0;
        bool useGateAll = 0;
        float readTime = millis();

        if (clockDivisionStepLeft == 0)
        {
          //LEFT DUO SEQUENCE
          // ----------------
          if (activeSequenceStepLeft != 99)
          {
            activeSequenceStepLeft++;
            if (activeSequenceStepLeft > sequenceLengthLeft) activeSequenceStepLeft = 0;

            if (sequenceNotesLeft[activeSequenceStepLeft] != 99) // NOTE NOT MUTED
            {
              activeChannelLeft = sequenceNotesLeft[activeSequenceStepLeft]; // SET ACTIVE LEFT CHANNEL
              activeChannelAll = activeChannelLeft;

              digitalWrite (channelOutput[0], 0); // TURN OFF LED 0
              digitalWrite (channelOutput[1], 0); // TURN OFF LED 1
              digitalWrite (channelOutput[2], 0); // TURN OFF LED 2
              digitalWrite (channelOutput[3], 0); // TURN OFF LED 3
              digitalWrite (channelOutput[4], 0); // TURN OFF LED 4

              if (sequenceNotesLeft[activeSequenceStepLeft] == 0) digitalWrite (channelOutput[0], 1); // TURN ON LED 0
              else if (sequenceNotesLeft[activeSequenceStepLeft] == 1) digitalWrite (channelOutput[1], 1); // TURN ON LED 1
              else if (sequenceNotesLeft[activeSequenceStepLeft] == 2) digitalWrite (channelOutput[2], 1); // TURN ON LED 2
              else if (sequenceNotesLeft[activeSequenceStepLeft] == 3) digitalWrite (channelOutput[3], 1); // TURN ON LED 3
              else if (sequenceNotesLeft[activeSequenceStepLeft] == 4) digitalWrite (channelOutput[4], 1); // TURN ON LED 4

              if (activeTouchChannelLeft != 99) sequenceYAxisLeft[activeSequenceStepLeft] = lastActiveSliderValueLeft;

              analogWrite(axisOutput[0], sequenceYAxisLeft[activeSequenceStepLeft]);  // LEFT Y-AXIS OUTPUT


              gateTimerLeft = gateLength + readTime;
              if (gateOutputLeftActive == 1)
              {
                digitalWrite(gateOutputLeft, 0);
                delay(1);
              }
              digitalWrite(gateOutputLeft, 1);
              gateOutputLeftActive = 1;

              leftUsed = 1;
              useGateAll = 1;
            }
          }
        }





        // ADVANCE DUO SEQUENCE RIGHT
        // ----------------------------------
        clockDivisionStepRight++;
        if (clockDivisionStepRight > clockDivisionRight) clockDivisionStepRight = 0;

        if (clockDivisionStepRight == 0)
        {
          //RIGHT DUO SEQUENCE
          // -----------------
          if (activeSequenceStepRight != 99)
          {
            activeSequenceStepRight++;
            if (activeSequenceStepRight > sequenceLengthRight) activeSequenceStepRight = 0;

            if (sequenceNotesRight[activeSequenceStepRight] != 99) // NOTE NOT MUTED
            {
              activeChannelRight = sequenceNotesRight[activeSequenceStepRight]; // SET ACTIVE RIGHT CHANNEL
              activeChannelAll = activeChannelRight;

              //channelOutput 2,14,15,16,17

              digitalWrite (channelOutput[5], 0); // TURN OFF LED 5
              digitalWrite (channelOutput[6], 0); // TURN OFF LED 6
              digitalWrite (channelOutput[7], 0); // TURN OFF LED 7
              digitalWrite (channelOutput[8], 0); // TURN OFF LED 8
              digitalWrite (channelOutput[9], 0); // TURN OFF LED 9

              if (sequenceNotesRight[activeSequenceStepRight] == 5) digitalWrite (channelOutput[5], 1); // TURN ON LED 5
              else if (sequenceNotesRight[activeSequenceStepRight] == 6) digitalWrite (channelOutput[6], 1); // TURN ON LED 6
              else if (sequenceNotesRight[activeSequenceStepRight] == 7) digitalWrite (channelOutput[7], 1); // TURN ON LED 7
              else if (sequenceNotesRight[activeSequenceStepRight] == 8) digitalWrite (channelOutput[8], 1); // TURN ON LED 8
              else if (sequenceNotesRight[activeSequenceStepRight] == 9) digitalWrite (channelOutput[9], 1); // TURN ON LED 9

              if (activeTouchChannelRight != 99) sequenceYAxisRight[activeSequenceStepRight] = lastActiveSliderValueRight;

              analogWrite(axisOutput[1], sequenceYAxisRight[activeSequenceStepRight]);  // RIGHT Y-AXIS OUTPUT

              gateTimerRight = gateLength + readTime;
              if (gateOutputRightActive == 1)
              {
                digitalWrite(gateOutputRight, 0);
                delay(1);
              }
              digitalWrite(gateOutputRight, 1);
              gateOutputRightActive = 1;

              rightUsed = 1;
              useGateAll = 1;
            }
          }
        }

        
        
        
        if (useGateAll == 1)
        {
          if (leftUsed == 1)
          {
            analogWrite(axisOutput[2], sequenceYAxisLeft[activeSequenceStepLeft]);  // ALL Y-AXIS OUTPUT
          }
          
          else
          {
            analogWrite(axisOutput[2], sequenceYAxisRight[activeSequenceStepRight]);  // ALL Y-AXIS OUTPUT
          }
            
          gateTimerAll = gateLength + readTime;
          if (gateOutputAllActive == 1)
          {
            digitalWrite(gateOutputAll, 0);
            delay(1);
          }
          digitalWrite(gateOutputAll, 1);
          gateOutputAllActive = 1;
        }
      }
    }
  }

  else
  {
    if (clockInputUsedCheckFlag == 0)
    {
      clockInputUsedCheckTimer = millis() + 3;
      clockInputUsedCheckFlag = 1;
    }
    else if (clockInputUsedCheckTimer < millis())
    {
      clockInputUsed = digitalRead(clockInput);
      clockInputUsedCheckFlag = 0;
    }
  }
}






// -------------------------------------------------------------------------------------------------------------------------------------------------------
// -------------------------------------------------------------------------------------------------------------------------------------------------------
// -------------------------------------------------------------------------------------------------------------------------------------------------------





//  RRRRRRRRRRRRRRRRR   EEEEEEEEEEEEEEEEEEEEEE   SSSSSSSSSSSSSSS EEEEEEEEEEEEEEEEEEEEEETTTTTTTTTTTTTTTTTTTTTTT     IIIIIIIIIINNNNNNNN        NNNNNNNN
//  R::::::::::::::::R  E::::::::::::::::::::E SS:::::::::::::::SE::::::::::::::::::::ET:::::::::::::::::::::T     I::::::::IN:::::::N       N::::::N
//  R::::::RRRRRR:::::R E::::::::::::::::::::ES:::::SSSSSS::::::SE::::::::::::::::::::ET:::::::::::::::::::::T     I::::::::IN::::::::N      N::::::N
//  RR:::::R     R:::::REE::::::EEEEEEEEE::::ES:::::S     SSSSSSSEE::::::EEEEEEEEE::::ET:::::TT:::::::TT:::::T     II::::::IIN:::::::::N     N::::::N
//    R::::R     R:::::R  E:::::E       EEEEEES:::::S              E:::::E       EEEEEETTTTTT  T:::::T  TTTTTT       I::::I  N::::::::::N    N::::::N
//    R::::R     R:::::R  E:::::E             S:::::S              E:::::E                     T:::::T               I::::I  N:::::::::::N   N::::::N
//    R::::RRRRRR:::::R   E::::::EEEEEEEEEE    S::::SSSS           E::::::EEEEEEEEEE           T:::::T               I::::I  N:::::::N::::N  N::::::N
//    R:::::::::::::RR    E:::::::::::::::E     SS::::::SSSSS      E:::::::::::::::E           T:::::T               I::::I  N::::::N N::::N N::::::N
//    R::::RRRRRR:::::R   E:::::::::::::::E       SSS::::::::SS    E:::::::::::::::E           T:::::T               I::::I  N::::::N  N::::N:::::::N
//    R::::R     R:::::R  E::::::EEEEEEEEEE          SSSSSS::::S   E::::::EEEEEEEEEE           T:::::T               I::::I  N::::::N   N:::::::::::N
//    R::::R     R:::::R  E:::::E                         S:::::S  E:::::E                     T:::::T               I::::I  N::::::N    N::::::::::N
//    R::::R     R:::::R  E:::::E       EEEEEE            S:::::S  E:::::E       EEEEEE        T:::::T               I::::I  N::::::N     N:::::::::N
//  RR:::::R     R:::::REE::::::EEEEEEEE:::::ESSSSSSS     S:::::SEE::::::EEEEEEEE:::::E      TT:::::::TT           II::::::IIN::::::N      N::::::::N
//  R::::::R     R:::::RE::::::::::::::::::::ES::::::SSSSSS:::::SE::::::::::::::::::::E      T:::::::::T           I::::::::IN::::::N       N:::::::N
//  R::::::R     R:::::RE::::::::::::::::::::ES:::::::::::::::SS E::::::::::::::::::::E      T:::::::::T           I::::::::IN::::::N        N::::::N
//  RRRRRRRR     RRRRRRREEEEEEEEEEEEEEEEEEEEEE SSSSSSSSSSSSSSS   EEEEEEEEEEEEEEEEEEEEEE      TTTTTTTTTTT           IIIIIIIIIINNNNNNNN         NNNNNNN


void resetInterrupted()
{
  resetInputTriggered = 1;  // RESET TRIGGED BY INTERRUPT
}






// -------------------------------------------------------------------------------------------------------------------------------------------------------
// -------------------------------------------------------------------------------------------------------------------------------------------------------
// -------------------------------------------------------------------------------------------------------------------------------------------------------





//     SSSSSSSSSSSSSSS         CCCCCCCCCCCCC               AAA               NNNNNNNN        NNNNNNNN     IIIIIIIIIINNNNNNNN        NNNNNNNN
//   SS:::::::::::::::S     CCC::::::::::::C              A:::A              N:::::::N       N::::::N     I::::::::IN:::::::N       N::::::N
//  S:::::SSSSSS::::::S   CC:::::::::::::::C             A:::::A             N::::::::N      N::::::N     I::::::::IN::::::::N      N::::::N
//  S:::::S     SSSSSSS  C:::::CCCCCCCC::::C            A:::::::A            N:::::::::N     N::::::N     II::::::IIN:::::::::N     N::::::N
//  S:::::S             C:::::C       CCCCCC           A:::::::::A           N::::::::::N    N::::::N       I::::I  N::::::::::N    N::::::N
//  S:::::S            C:::::C                        A:::::A:::::A          N:::::::::::N   N::::::N       I::::I  N:::::::::::N   N::::::N
//   S::::SSSS         C:::::C                       A:::::A A:::::A         N:::::::N::::N  N::::::N       I::::I  N:::::::N::::N  N::::::N
//    SS::::::SSSSS    C:::::C                      A:::::A   A:::::A        N::::::N N::::N N::::::N       I::::I  N::::::N N::::N N::::::N
//      SSS::::::::SS  C:::::C                     A:::::A     A:::::A       N::::::N  N::::N:::::::N       I::::I  N::::::N  N::::N:::::::N
//         SSSSSS::::S C:::::C                    A:::::AAAAAAAAA:::::A      N::::::N   N:::::::::::N       I::::I  N::::::N   N:::::::::::N
//              S:::::SC:::::C                   A:::::::::::::::::::::A     N::::::N    N::::::::::N       I::::I  N::::::N    N::::::::::N
//              S:::::S C:::::C       CCCCCC    A:::::AAAAAAAAAAAAA:::::A    N::::::N     N:::::::::N       I::::I  N::::::N     N:::::::::N
//  SSSSSSS     S:::::S  C:::::CCCCCCCC::::C   A:::::A             A:::::A   N::::::N      N::::::::N     II::::::IIN::::::N      N::::::::N
//  S::::::SSSSSS:::::S   CC:::::::::::::::C  A:::::A               A:::::A  N::::::N       N:::::::N     I::::::::IN::::::N       N:::::::N
//  S:::::::::::::::SS      CCC::::::::::::C A:::::A                 A:::::A N::::::N        N::::::N     I::::::::IN::::::N        N::::::N
//   SSSSSSSSSSSSSSS           CCCCCCCCCCCCCAAAAAAA                   AAAAAAANNNNNNNN         NNNNNNN     IIIIIIIIIINNNNNNNN         NNNNNNN

bool scanInputUsed = 0;
byte lastScannedChannel = 99;
byte scannedChannel = 99;

void checkScan()
{
  float readTime = millis();
  int scanInputValue = analogRead(scanInput); 

  if(noteMode == 0)
  {
    if (scanInputValue < 478) scannedChannel = 0;
    else if (scanInputValue >= 478 && scanInputValue < 756) scannedChannel = 1;
    else if (scanInputValue >= 756 && scanInputValue < 1034) scannedChannel = 2;
    else if (scanInputValue >= 1034 && scanInputValue < 1312) scannedChannel = 3;
    else if (scanInputValue >= 1312 && scanInputValue < 1590) scannedChannel = 4;
    else if (scanInputValue >= 1590 && scanInputValue < 1868) scannedChannel = 5;
    else if (scanInputValue >= 1868 && scanInputValue < 2146) scannedChannel = 6;
    else if (scanInputValue >= 2146 && scanInputValue < 2424) scannedChannel = 7;
    else if (scanInputValue >= 2424 && scanInputValue < 2702) scannedChannel = 8;
    else if (scanInputValue >= 2702) scannedChannel = 9;

    //if (scanInputValue < 278) scannedChannel = 0;
    //else if (scanInputValue >= 278 && scanInputValue < 556) scannedChannel = 1;
    //else if (scanInputValue >= 556 && scanInputValue < 834) scannedChannel = 2;
    //else if (scanInputValue >= 834 && scanInputValue < 1112) scannedChannel = 3;
    //else if (scanInputValue >= 1112 && scanInputValue < 1390) scannedChannel = 4;
    //else if (scanInputValue >= 1390 && scanInputValue < 1668) scannedChannel = 5;
    //else if (scanInputValue >= 1668 && scanInputValue < 1946) scannedChannel = 6;
    //else if (scanInputValue >= 1946 && scanInputValue < 2224) scannedChannel = 7;
    //else if (scanInputValue >= 2224 && scanInputValue < 2502) scannedChannel = 8;
    //else if (scanInputValue >= 2502) scannedChannel = 9;

    if (scannedChannel != lastScannedChannel)
    {
      lastScannedChannel = scannedChannel;

      digitalWrite (channelOutput[0], 0); // TURN OFF LED 0
      digitalWrite (channelOutput[1], 0); // TURN OFF LED 1
      digitalWrite (channelOutput[2], 0); // TURN OFF LED 2
      digitalWrite (channelOutput[3], 0); // TURN OFF LED 3
      digitalWrite (channelOutput[4], 0); // TURN OFF LED 4
      digitalWrite (channelOutput[5], 0); // TURN OFF LED 5
      digitalWrite (channelOutput[6], 0); // TURN OFF LED 6
      digitalWrite (channelOutput[7], 0); // TURN OFF LED 7
      digitalWrite (channelOutput[8], 0); // TURN OFF LED 8
      digitalWrite (channelOutput[9], 0); // TURN OFF LED 9
    
      if (scannedChannel < 5)
      {
        digitalWrite(allSelectorA, 0);
        digitalWrite(allSelectorB, 1);
        digitalWrite(allSelectorC, 0);
        digitalWrite(allSelectorD, 1);
      }

      else
      {
        digitalWrite(allSelectorA, 1);
        digitalWrite(allSelectorB, 0);
        digitalWrite(allSelectorC, 1);
        digitalWrite(allSelectorD, 0);
      }
      

      if (scannedChannel == 0) digitalWrite (channelOutput[0], 1); // TURN ON LED 0
      else if (scannedChannel == 1) digitalWrite (channelOutput[1], 1); // TURN ON LED 1
      else if (scannedChannel == 2) digitalWrite (channelOutput[2], 1); // TURN ON LED 2
      else if (scannedChannel == 3) digitalWrite (channelOutput[3], 1); // TURN ON LED 3
      else if (scannedChannel == 4) digitalWrite (channelOutput[4], 1); // TURN ON LED 4
      else if (scannedChannel == 5) digitalWrite (channelOutput[5], 1); // TURN ON LED 5
      else if (scannedChannel == 6) digitalWrite (channelOutput[6], 1); // TURN ON LED 6
      else if (scannedChannel == 7) digitalWrite (channelOutput[7], 1); // TURN ON LED 7
      else if (scannedChannel == 8) digitalWrite (channelOutput[8], 1); // TURN ON LED 8
      else if (scannedChannel == 9) digitalWrite (channelOutput[9], 1); // TURN ON LED 9

      if (scannedChannel < 5)
      {
        if (gateTimerLeft != 0 || gateTimerAll != 0)
        {
          digitalWrite(gateOutputLeft, 0);
          digitalWrite(gateOutputAll, 0);
          gateOutputAllActive = 0;
          gateOutputLeftActive = 0;
          delay(1);
        }
        gateTimerLeft = gateLength + readTime;
        gateTimerAll = gateLength + readTime;

        if (gateOutputAllActive == 1) digitalWrite(gateOutputAll, 0);
        if (gateOutputLeftActive == 1)digitalWrite(gateOutputLeft, 0);
        if (gateOutputAllActive == 1 || gateOutputLeftActive == 1) delay(1);

        digitalWrite(gateOutputLeft, 1); // ENABLE LEFT GATE
        digitalWrite(gateOutputAll, 1); // ENABLE ALL GATE
        gateOutputAllActive = 1;
        gateOutputLeftActive = 1;
      }

      else
      {
        if (gateTimerRight != 0 || gateTimerAll != 0)
        {
          digitalWrite(gateOutputRight, 0);
          digitalWrite(gateOutputAll, 0);
          gateOutputAllActive = 0;
          gateOutputRightActive = 0;
          delay(1);
        }
        gateTimerRight = gateLength + readTime;
        gateTimerAll = gateLength + readTime;
        
        if (gateOutputAllActive == 1) digitalWrite(gateOutputAll, 0);
        if (gateOutputRightActive == 1) digitalWrite(gateOutputRight, 0);
        if (gateOutputAllActive == 1 || gateOutputRightActive == 1) delay(1);
        digitalWrite(gateOutputRight, 1); // ENABLE RIGHT GATE
        digitalWrite(gateOutputAll, 1); // ENABLE ALL GATE
        gateOutputAllActive = 1;
        gateOutputRightActive = 1;
      }
    }
  }

  else // if(noteMode == 1)
  {    
    if (scanInputValue < 760) scannedChannel = 0;
    else if (scanInputValue >= 760 && scanInputValue < 1420) scannedChannel = 1;
    else if (scanInputValue >= 1420 && scanInputValue < 2080) scannedChannel = 2;
    else if (scanInputValue >= 2080 && scanInputValue < 2740) scannedChannel = 3;
    else if (scanInputValue >= 2740) scannedChannel = 4;

    if (scannedChannel != lastScannedChannel)
    {
      lastScannedChannel = scannedChannel;

      digitalWrite (channelOutput[0], 0); // TURN OFF LED 0
      digitalWrite (channelOutput[1], 0); // TURN OFF LED 1
      digitalWrite (channelOutput[2], 0); // TURN OFF LED 2
      digitalWrite (channelOutput[3], 0); // TURN OFF LED 3
      digitalWrite (channelOutput[4], 0); // TURN OFF LED 4
      digitalWrite (channelOutput[5], 0); // TURN OFF LED 5
      digitalWrite (channelOutput[6], 0); // TURN OFF LED 6
      digitalWrite (channelOutput[7], 0); // TURN OFF LED 7
      digitalWrite (channelOutput[8], 0); // TURN OFF LED 8
      digitalWrite (channelOutput[9], 0); // TURN OFF LED 9
      

      if (gateTimerLeft != 0 || gateTimerRight != 0 || gateTimerAll != 0)
      {
        digitalWrite(gateOutputLeft, 0);
        digitalWrite(gateOutputRight, 0);
        digitalWrite(gateOutputAll, 0);

        gateOutputAllActive = 0;
        gateOutputLeftActive = 0;
        gateOutputRightActive = 0;
        delay(1);
      }


      if (scannedChannel == 0)
      {
        digitalWrite (channelOutput[0], 1); // TURN ON LED 0
        digitalWrite (channelOutput[5], 1); // TURN ON LED 5

        gateTimerLeft = gateLength + readTime;
        gateTimerRight = gateLength + readTime;
        gateTimerAll = gateLength + readTime;

        if (gateOutputAllActive == 1) digitalWrite(gateOutputAll, 0);
        if (gateOutputLeftActive == 1) digitalWrite(gateOutputLeft, 0);
        if (gateOutputRightActive == 1) digitalWrite(gateOutputRight, 0);
        if (gateOutputAllActive == 1 || gateOutputLeftActive == 1 || gateOutputRightActive == 1) delay(1);

        digitalWrite(gateOutputLeft, 1); // ENABLE LEFT GATE
        digitalWrite(gateOutputRight, 1); // ENABLE RIGHT GATE
        digitalWrite(gateOutputAll, 1); // ENABLE ALL GATE

        gateOutputAllActive = 1;
        gateOutputLeftActive = 1;
        gateOutputRightActive = 1;
      }
      else if (scannedChannel == 1)
      {
        digitalWrite (channelOutput[1], 1); // TURN ON LED 1
        digitalWrite (channelOutput[6], 1); // TURN ON LED 6

        gateTimerLeft = gateLength + readTime;
        gateTimerRight = gateLength + readTime;
        gateTimerAll = gateLength + readTime;

        if (gateOutputAllActive == 1) digitalWrite(gateOutputAll, 0);
        if (gateOutputLeftActive == 1) digitalWrite(gateOutputLeft, 0);
        if (gateOutputRightActive == 1) digitalWrite(gateOutputRight, 0);
        if (gateOutputAllActive == 1 || gateOutputLeftActive == 1 || gateOutputRightActive == 1) delay(1);

        digitalWrite(gateOutputLeft, 1); // ENABLE LEFT GATE
        digitalWrite(gateOutputRight, 1); // ENABLE RIGHT GATE
        digitalWrite(gateOutputAll, 1); // ENABLE ALL GATE

        gateOutputAllActive = 1;
        gateOutputLeftActive = 1;
        gateOutputRightActive = 1;
      }
      else if (scannedChannel == 2)
      {
        digitalWrite (channelOutput[2], 1); // TURN ON LED 2
        digitalWrite (channelOutput[7], 1); // TURN ON LED 7

        gateTimerLeft = gateLength + readTime;
        gateTimerRight = gateLength + readTime;
        gateTimerAll = gateLength + readTime;

        if (gateOutputAllActive == 1) digitalWrite(gateOutputAll, 0);
        if (gateOutputLeftActive == 1) digitalWrite(gateOutputLeft, 0);
        if (gateOutputRightActive == 1) digitalWrite(gateOutputRight, 0);
        if (gateOutputAllActive == 1 || gateOutputLeftActive == 1 || gateOutputRightActive == 1) delay(1);

        digitalWrite(gateOutputLeft, 1); // ENABLE LEFT GATE
        digitalWrite(gateOutputRight, 1); // ENABLE RIGHT GATE
        digitalWrite(gateOutputAll, 1); // ENABLE ALL GATE

        gateOutputAllActive = 1;
        gateOutputLeftActive = 1;
        gateOutputRightActive = 1;
      }
      else if (scannedChannel == 3)
      {
        digitalWrite (channelOutput[3], 1); // TURN ON LED 3
        digitalWrite (channelOutput[8], 1); // TURN ON LED 8

        gateTimerLeft = gateLength + readTime;
        gateTimerRight = gateLength + readTime;
        gateTimerAll = gateLength + readTime;

        if (gateOutputAllActive == 1) digitalWrite(gateOutputAll, 0);
        if (gateOutputLeftActive == 1) digitalWrite(gateOutputLeft, 0);
        if (gateOutputRightActive == 1) digitalWrite(gateOutputRight, 0);
        if (gateOutputAllActive == 1 || gateOutputLeftActive == 1 || gateOutputRightActive == 1) delay(1);

        digitalWrite(gateOutputLeft, 1); // ENABLE LEFT GATE
        digitalWrite(gateOutputRight, 1); // ENABLE RIGHT GATE
        digitalWrite(gateOutputAll, 1); // ENABLE ALL GATE

        gateOutputAllActive = 1;
        gateOutputLeftActive = 1;
        gateOutputRightActive = 1;
      }
      else if (scannedChannel == 4)
      {
        digitalWrite (channelOutput[4], 1); // TURN ON LED 4
        digitalWrite (channelOutput[9], 1); // TURN ON LED 9

        gateTimerLeft = gateLength + readTime;
        gateTimerRight = gateLength + readTime;
        gateTimerAll = gateLength + readTime;

        if (gateOutputAllActive == 1) digitalWrite(gateOutputAll, 0);
        if (gateOutputLeftActive == 1) digitalWrite(gateOutputLeft, 0);
        if (gateOutputRightActive == 1) digitalWrite(gateOutputRight, 0);
        if (gateOutputAllActive == 1 || gateOutputLeftActive == 1 || gateOutputRightActive == 1) delay(1);

        digitalWrite(gateOutputLeft, 1); // ENABLE LEFT GATE
        digitalWrite(gateOutputRight, 1); // ENABLE RIGHT GATE
        digitalWrite(gateOutputAll, 1); // ENABLE ALL GATE

        gateOutputAllActive = 1;
        gateOutputLeftActive = 1;
        gateOutputRightActive = 1;
      }
    }
  }

}





// -------------------------------------------------------------------------------------------------------------------------------------------------------
// -------------------------------------------------------------------------------------------------------------------------------------------------------
// -------------------------------------------------------------------------------------------------------------------------------------------------------





//  MMMMMMMM               MMMMMMMM     OOOOOOOOO     NNNNNNNN        NNNNNNNN     OOOOOOOOO          BBBBBBBBBBBBBBBBB   TTTTTTTTTTTTTTTTTTTTTTTNNNNNNNN        NNNNNNNN
//  M:::::::M             M:::::::M   OO:::::::::OO   N:::::::N       N::::::N   OO:::::::::OO        B::::::::::::::::B  T:::::::::::::::::::::TN:::::::N       N::::::N
//  M::::::::M           M::::::::M OO:::::::::::::OO N::::::::N      N::::::N OO:::::::::::::OO      B::::::BBBBBB:::::B T:::::::::::::::::::::TN::::::::N      N::::::N
//  M:::::::::M         M:::::::::MO:::::::OOO:::::::ON:::::::::N     N::::::NO:::::::OOO:::::::O     BB:::::B     B:::::BT:::::TT:::::::TT:::::TN:::::::::N     N::::::N
//  M::::::::::M       M::::::::::MO::::::O   O::::::ON::::::::::N    N::::::NO::::::O   O::::::O       B::::B     B:::::BTTTTTT  T:::::T  TTTTTTN::::::::::N    N::::::N
//  M:::::::::::M     M:::::::::::MO:::::O     O:::::ON:::::::::::N   N::::::NO:::::O     O:::::O       B::::B     B:::::B        T:::::T        N:::::::::::N   N::::::N
//  M:::::::M::::M   M::::M:::::::MO:::::O     O:::::ON:::::::N::::N  N::::::NO:::::O     O:::::O       B::::BBBBBB:::::B         T:::::T        N:::::::N::::N  N::::::N
//  M::::::M M::::M M::::M M::::::MO:::::O     O:::::ON::::::N N::::N N::::::NO:::::O     O:::::O       B:::::::::::::BB          T:::::T        N::::::N N::::N N::::::N
//  M::::::M  M::::M::::M  M::::::MO:::::O     O:::::ON::::::N  N::::N:::::::NO:::::O     O:::::O       B::::BBBBBB:::::B         T:::::T        N::::::N  N::::N:::::::N
//  M::::::M   M:::::::M   M::::::MO:::::O     O:::::ON::::::N   N:::::::::::NO:::::O     O:::::O       B::::B     B:::::B        T:::::T        N::::::N   N:::::::::::N
//  M::::::M    M:::::M    M::::::MO:::::O     O:::::ON::::::N    N::::::::::NO:::::O     O:::::O       B::::B     B:::::B        T:::::T        N::::::N    N::::::::::N
//  M::::::M     MMMMM     M::::::MO::::::O   O::::::ON::::::N     N:::::::::NO::::::O   O::::::O       B::::B     B:::::B        T:::::T        N::::::N     N:::::::::N
//  M::::::M               M::::::MO:::::::OOO:::::::ON::::::N      N::::::::NO:::::::OOO:::::::O     BB:::::BBBBBB::::::B      TT:::::::TT      N::::::N      N::::::::N
//  M::::::M               M::::::M OO:::::::::::::OO N::::::N       N:::::::N OO:::::::::::::OO      B:::::::::::::::::B       T:::::::::T      N::::::N       N:::::::N
//  M::::::M               M::::::M   OO:::::::::OO   N::::::N        N::::::N   OO:::::::::OO        B::::::::::::::::B        T:::::::::T      N::::::N        N::::::N
//  MMMMMMMM               MMMMMMMM     OOOOOOOOO     NNNNNNNN         NNNNNNN     OOOOOOOOO          BBBBBBBBBBBBBBBBB         TTTTTTTTTTT      NNNNNNNN         NNNNNNN



void pressMonoButton()
{	
  if (duoButtonState == 0)
  {
    monoButtonState = digitalRead(monoButton);

    if (monoButtonState == 1) 
    {
      if (monoButtonChangeEnabled == 1)
      {
        // MONO BUTTON ON
        // ------------------------------------
        monoButtonChangeEnabled = 0;
        monoButtonPressed = 1;
        
        if (restButtonPressed == 1)
        {
          externalClockResetDisabled = 1;

          for (byte x = 0; x < 10; x++) // CLEAR PRESSED KEYS
          {
            autoCalibrateSwitch(x,1);
            capAxis[x].reset_CS_AutoCal();

            digitalWrite (channelOutput[0], 0); // TURN OFF LED 5
            digitalWrite (channelOutput[1], 0); // TURN OFF LED 6
            digitalWrite (channelOutput[2], 0); // TURN OFF LED 7
            digitalWrite (channelOutput[3], 0); // TURN OFF LED 8
            digitalWrite (channelOutput[4], 0); // TURN OFF LED 9
            digitalWrite (channelOutput[5], 0); // TURN OFF LED 5
            digitalWrite (channelOutput[6], 0); // TURN OFF LED 6
            digitalWrite (channelOutput[7], 0); // TURN OFF LED 7
            digitalWrite (channelOutput[8], 0); // TURN OFF LED 8
            digitalWrite (channelOutput[9], 0); // TURN OFF LED 9

            if (noteMode == 0)
            {
              digitalWrite (channelOutput[activeChannelAll], 1); // TURN ON ACTIVE CHANNEL
            }
            else
            {
              digitalWrite (channelOutput[activeChannelLeft], 1); // TURN ON ACTIVE CHANNEL
              digitalWrite (channelOutput[activeChannelRight], 1); // TURN ON ACTIVE CHANNEL
            }
          }
        }
        
        else
        {
          // MONO SEQUENCE PROGRAMMING
          monoNotePressed = 0;
          monoNotePressedMono = 0;

          if (noteMode == 0)
          {
            enableSequenceEdit = 1;
          }

          else //if (noteMode == 1)
          {
            for (byte x = 0; x < 10; x++) // CLEAR PRESSED KEYS
            {
              capSwitchState[x] = 0;
            }

            for (byte x = 0; x < 64; x++) // CLEAR DUO SEQUENCES
            {
              sequenceNotesLeft[x] = 0;
              sequenceNotesRight[x] = 0;
            }

            activeSequenceStepLeft = 99;
            activeSequenceStepRight = 99;

            sequenceLengthLeft = 0;
            sequenceLengthRight = 0;

            duoNotePressedLeft = 1;
            duoNotePressedRight = 1;

            noteMode = 0;
            digitalWrite (channelOutput[0], 0); // TURN OFF LED 5
            digitalWrite (channelOutput[1], 0); // TURN OFF LED 6
            digitalWrite (channelOutput[2], 0); // TURN OFF LED 7
            digitalWrite (channelOutput[3], 0); // TURN OFF LED 8
            digitalWrite (channelOutput[4], 0); // TURN OFF LED 9
            digitalWrite (channelOutput[5], 0); // TURN OFF LED 5
            digitalWrite (channelOutput[6], 0); // TURN OFF LED 6
            digitalWrite (channelOutput[7], 0); // TURN OFF LED 7
            digitalWrite (channelOutput[8], 0); // TURN OFF LED 8
            digitalWrite (channelOutput[9], 0); // TURN OFF LED 9

            digitalWrite (channelOutput[activeChannelAll], 1); // TURN ON ACTIVE CHANNEL

            digitalWrite(allSelectorA, 1);
            digitalWrite(allSelectorB, 1);
            digitalWrite(allSelectorC, 1);
            digitalWrite(allSelectorD, 1);
          }
        }
      }
    }

    // MONO BUTTON OFF
    // ------------------------------------
    else if (monoButtonState == 0)
    {
      if (monoButtonPressed == 1)
      {
        monoButtonPressed = 0;
        enableSequenceEdit = 0;

        if (monoNotePressed == 0)
        {
          for (byte x = 0; x < 64; x++) // CLEAR MONO SEQUENCE
          {
            sequenceNotesMono[x] = 0;
          }

          activeSequenceStepLeft = 99;
          activeSequenceStepRight = 99;
          activeSequenceStepMono = 99;
          sequenceLengthMono = 0;
          monoNotePressedMono = 1;
        }
      }

      monoButtonChangeEnabled = 1;
    }
  }
}





// -------------------------------------------------------------------------------------------------------------------------------------------------------
// -------------------------------------------------------------------------------------------------------------------------------------------------------
// -------------------------------------------------------------------------------------------------------------------------------------------------------





//  RRRRRRRRRRRRRRRRR   EEEEEEEEEEEEEEEEEEEEEE   SSSSSSSSSSSSSSS TTTTTTTTTTTTTTTTTTTTTTT     BBBBBBBBBBBBBBBBB   TTTTTTTTTTTTTTTTTTTTTTTNNNNNNNN        NNNNNNNN
//  R::::::::::::::::R  E::::::::::::::::::::E SS:::::::::::::::ST:::::::::::::::::::::T     B::::::::::::::::B  T:::::::::::::::::::::TN:::::::N       N::::::N
//  R::::::RRRRRR:::::R E::::::::::::::::::::ES:::::SSSSSS::::::ST:::::::::::::::::::::T     B::::::BBBBBB:::::B T:::::::::::::::::::::TN::::::::N      N::::::N
//  RR:::::R     R:::::REE::::::EEEEEEEEE::::ES:::::S     SSSSSSST:::::TT:::::::TT:::::T     BB:::::B     B:::::BT:::::TT:::::::TT:::::TN:::::::::N     N::::::N
//    R::::R     R:::::R  E:::::E       EEEEEES:::::S            TTTTTT  T:::::T  TTTTTT       B::::B     B:::::BTTTTTT  T:::::T  TTTTTTN::::::::::N    N::::::N
//    R::::R     R:::::R  E:::::E             S:::::S                    T:::::T               B::::B     B:::::B        T:::::T        N:::::::::::N   N::::::N
//    R::::RRRRRR:::::R   E::::::EEEEEEEEEE    S::::SSSS                 T:::::T               B::::BBBBBB:::::B         T:::::T        N:::::::N::::N  N::::::N
//    R:::::::::::::RR    E:::::::::::::::E     SS::::::SSSSS            T:::::T               B:::::::::::::BB          T:::::T        N::::::N N::::N N::::::N
//    R::::RRRRRR:::::R   E:::::::::::::::E       SSS::::::::SS          T:::::T               B::::BBBBBB:::::B         T:::::T        N::::::N  N::::N:::::::N
//    R::::R     R:::::R  E::::::EEEEEEEEEE          SSSSSS::::S         T:::::T               B::::B     B:::::B        T:::::T        N::::::N   N:::::::::::N
//    R::::R     R:::::R  E:::::E                         S:::::S        T:::::T               B::::B     B:::::B        T:::::T        N::::::N    N::::::::::N
//    R::::R     R:::::R  E:::::E       EEEEEE            S:::::S        T:::::T               B::::B     B:::::B        T:::::T        N::::::N     N:::::::::N
//  RR:::::R     R:::::REE::::::EEEEEEEE:::::ESSSSSSS     S:::::S      TT:::::::TT           BB:::::BBBBBB::::::B      TT:::::::TT      N::::::N      N::::::::N
//  R::::::R     R:::::RE::::::::::::::::::::ES::::::SSSSSS:::::S      T:::::::::T           B:::::::::::::::::B       T:::::::::T      N::::::N       N:::::::N
//  R::::::R     R:::::RE::::::::::::::::::::ES:::::::::::::::SS       T:::::::::T           B::::::::::::::::B        T:::::::::T      N::::::N        N::::::N
//  RRRRRRRR     RRRRRRREEEEEEEEEEEEEEEEEEEEEE SSSSSSSSSSSSSSS         TTTTTTTTTTT           BBBBBBBBBBBBBBBBB         TTTTTTTTTTT      NNNNNNNN         NNNNNNN

bool restButtonState = 0;
bool restButtonChangeEnabled = 1;

void pressRestButton()
{	
  restButtonState = digitalRead(restButton);
	if (restButtonState == 1) 
	{
    if (restButtonChangeEnabled == 1)
    {
      restButtonChangeEnabled = 0;
      if (monoButtonPressed == 0 && duoButtonPressed == 0)
      {
        restButtonPressed = 1;
        externalClockResetDisabled = 0;
      }
      




      else if (monoButtonPressed == 1)
      {
        monoNotePressed = 1;
        externalClockResetDisabled = 1;

        if (monoNotePressedMono == 0)
        {
          monoNotePressedMono = 1;

          for (byte y = 0; y < 64; y++) // CLEAR MONO SEQUENCES
          {
            sequenceNotesMono[y] = 0;
          }

          activeSequenceStepMono = 99;
          sequenceLengthMono = 0;
        }

        if (sequenceLengthMono < 63)
        {
          if (activeSequenceStepMono == 99)
          {
            activeSequenceStepMono = 88;
            sequenceLengthMono= 0;
            sequenceNotesMono[0] = 99;
          }
          else
          {
            sequenceLengthMono++;
            sequenceNotesMono[sequenceLengthMono] = 99;
          }
        }
      }




      else if (duoButtonPressed == 1)
      {
        externalClockResetDisabled = 1;

        if (lastDuoNotePressed == 0)
        {
          if (sequenceLengthLeft < 63)
          {
            sequenceLengthLeft++;
            sequenceNotesLeft[sequenceLengthLeft] = 99;
            
          }
        }

        else if (lastDuoNotePressed == 1)
        {
          if (sequenceLengthRight < 63)
          {
            sequenceLengthRight++;
            sequenceNotesRight[sequenceLengthRight] = 99;
          }
        }
      }
    }
	}




	else if (restButtonState == 0)
  {
    if (restButtonChangeEnabled == 0)
    {
      restButtonChangeEnabled = 1;

      if (externalClockResetDisabled == 0)
      {
        resetInputUsed = 1;

        if (activeSequenceStepMono != 99) activeSequenceStepMono = 88;
        if (activeSequenceStepLeft != 99) activeSequenceStepLeft = 88;
        if (activeSequenceStepRight != 99) activeSequenceStepRight = 88;

        clockDivisionStepMono = 99;
        clockDivisionStepLeft = 99;
        clockDivisionStepRight = 99;
      }
    }
    
    restButtonPressed = 0;
  }
}





// -------------------------------------------------------------------------------------------------------------------------------------------------------
// -------------------------------------------------------------------------------------------------------------------------------------------------------
// -------------------------------------------------------------------------------------------------------------------------------------------------------





//  DDDDDDDDDDDDD       UUUUUUUU     UUUUUUUU     OOOOOOOOO          BBBBBBBBBBBBBBBBB   TTTTTTTTTTTTTTTTTTTTTTTNNNNNNNN        NNNNNNNN
//  D::::::::::::DDD    U::::::U     U::::::U   OO:::::::::OO        B::::::::::::::::B  T:::::::::::::::::::::TN:::::::N       N::::::N
//  D:::::::::::::::DD  U::::::U     U::::::U OO:::::::::::::OO      B::::::BBBBBB:::::B T:::::::::::::::::::::TN::::::::N      N::::::N
//  DDD:::::DDDDD:::::D UU:::::U     U:::::UUO:::::::OOO:::::::O     BB:::::B     B:::::BT:::::TT:::::::TT:::::TN:::::::::N     N::::::N
//    D:::::D    D:::::D U:::::U     U:::::U O::::::O   O::::::O       B::::B     B:::::BTTTTTT  T:::::T  TTTTTTN::::::::::N    N::::::N
//    D:::::D     D:::::DU:::::D     D:::::U O:::::O     O:::::O       B::::B     B:::::B        T:::::T        N:::::::::::N   N::::::N
//    D:::::D     D:::::DU:::::D     D:::::U O:::::O     O:::::O       B::::BBBBBB:::::B         T:::::T        N:::::::N::::N  N::::::N
//    D:::::D     D:::::DU:::::D     D:::::U O:::::O     O:::::O       B:::::::::::::BB          T:::::T        N::::::N N::::N N::::::N
//    D:::::D     D:::::DU:::::D     D:::::U O:::::O     O:::::O       B::::BBBBBB:::::B         T:::::T        N::::::N  N::::N:::::::N
//    D:::::D     D:::::DU:::::D     D:::::U O:::::O     O:::::O       B::::B     B:::::B        T:::::T        N::::::N   N:::::::::::N
//    D:::::D     D:::::DU:::::D     D:::::U O:::::O     O:::::O       B::::B     B:::::B        T:::::T        N::::::N    N::::::::::N
//    D:::::D    D:::::D U::::::U   U::::::U O::::::O   O::::::O       B::::B     B:::::B        T:::::T        N::::::N     N:::::::::N
//  DDD:::::DDDDD:::::D  U:::::::UUU:::::::U O:::::::OOO:::::::O     BB:::::BBBBBB::::::B      TT:::::::TT      N::::::N      N::::::::N
//  D:::::::::::::::DD    UU:::::::::::::UU   OO:::::::::::::OO      B:::::::::::::::::B       T:::::::::T      N::::::N       N:::::::N
//  D::::::::::::DDD        UU:::::::::UU       OO:::::::::OO        B::::::::::::::::B        T:::::::::T      N::::::N        N::::::N
//  DDDDDDDDDDDDD             UUUUUUUUU           OOOOOOOOO          BBBBBBBBBBBBBBBBB         TTTTTTTTTTT      NNNNNNNN         NNNNNNN



void pressDuoButton()
{	
  if (monoButtonState == 0)
  {
    duoButtonState = digitalRead(duoButton);

    // DUO BUTTON ON
    // ------------------------------------
    if (duoButtonState == 1) 
    {
      if (duoButtonChangeEnabled == 1)
      {
        duoButtonChangeEnabled = 0;
        duoButtonPressed = 1;

        if (restButtonPressed == 1)
        {
          externalClockResetDisabled = 1;

          for (byte x = 0; x < 10; x++) // CLEAR PRESSED KEYS
          {
            autoCalibrateSwitch(x,1);
            capAxis[x].reset_CS_AutoCal();

            digitalWrite (channelOutput[0], 0); // TURN OFF LED 5
            digitalWrite (channelOutput[1], 0); // TURN OFF LED 6
            digitalWrite (channelOutput[2], 0); // TURN OFF LED 7
            digitalWrite (channelOutput[3], 0); // TURN OFF LED 8
            digitalWrite (channelOutput[4], 0); // TURN OFF LED 9
            digitalWrite (channelOutput[5], 0); // TURN OFF LED 5
            digitalWrite (channelOutput[6], 0); // TURN OFF LED 6
            digitalWrite (channelOutput[7], 0); // TURN OFF LED 7
            digitalWrite (channelOutput[8], 0); // TURN OFF LED 8
            digitalWrite (channelOutput[9], 0); // TURN OFF LED 9

            if (noteMode == 0)
            {
              digitalWrite (channelOutput[activeChannelAll], 1); // TURN ON ACTIVE CHANNEL
            }
            else
            {
              digitalWrite (channelOutput[activeChannelLeft], 1); // TURN ON ACTIVE CHANNEL
              digitalWrite (channelOutput[activeChannelRight], 1); // TURN ON ACTIVE CHANNEL
            }
          }
        }
        
        else
        {
          if (noteMode == 1)
          {
            enableSequenceEdit = 1;
          }

          else //if (noteMode == 0)
          {
            for (byte x = 0; x < 10; x++) // CLEAR PRESSED KEYS
            {
              capSwitchState[x] = 0;
            }

            noteMode = 1;
            lastDuoNotePressed = 0;

            digitalWrite (channelOutput[0], 0); // TURN OFF LED 5
            digitalWrite (channelOutput[1], 0); // TURN OFF LED 6
            digitalWrite (channelOutput[2], 0); // TURN OFF LED 7
            digitalWrite (channelOutput[3], 0); // TURN OFF LED 8
            digitalWrite (channelOutput[4], 0); // TURN OFF LED 9
            digitalWrite (channelOutput[5], 0); // TURN OFF LED 5
            digitalWrite (channelOutput[6], 0); // TURN OFF LED 6
            digitalWrite (channelOutput[7], 0); // TURN OFF LED 7
            digitalWrite (channelOutput[8], 0); // TURN OFF LED 8
            digitalWrite (channelOutput[9], 0); // TURN OFF LED 9

            digitalWrite (channelOutput[activeChannelLeft], 1); // TURN ON ACTIVE CHANNEL LEFT
            digitalWrite (channelOutput[activeChannelRight], 1); // TURN ON ACTIVE CHANNEL RIGHT

            digitalWrite(allSelectorA, 0);
            digitalWrite(allSelectorB, 0);
            digitalWrite(allSelectorC, 0);
            digitalWrite(allSelectorD, 0);
          }

          // DUO SEQUENCE PROGRAMMING
          duoNotePressed = 0;
          duoNotePressedLeft = 0;
          duoNotePressedRight = 0;
        }
      }
    }

    // DUO BUTTON OFF
    // ------------------------------------
    else if (duoButtonState == 0)
    {
      if (duoButtonPressed == 1)
      {
        duoButtonPressed = 0;
        enableSequenceEdit = 0;

        if (duoNotePressed == 0)
        {
          for (byte x = 0; x < 64; x++) // CLEAR DUO SEQUENCES
          {
            sequenceNotesLeft[x] = 0;
            sequenceNotesRight[x] = 0;
          }

          activeSequenceStepLeft = 99;
          activeSequenceStepRight = 99;
          activeSequenceStepMono = 99;

          sequenceLengthLeft = 0;
          sequenceLengthRight = 0;

          duoNotePressedLeft = 1;
          duoNotePressedRight = 1;
        }
      }

      duoButtonChangeEnabled = 1;
    }
  }
}








// -------------------------------------------------------------------------------------------------------------------------------------------------------
// -------------------------------------------------------------------------------------------------------------------------------------------------------
// -------------------------------------------------------------------------------------------------------------------------------------------------------










//     SSSSSSSSSSSSSSS EEEEEEEEEEEEEEEEEEEEEETTTTTTTTTTTTTTTTTTTTTTTUUUUUUUU     UUUUUUUUPPPPPPPPPPPPPPPPP   
//   SS:::::::::::::::SE::::::::::::::::::::ET:::::::::::::::::::::TU::::::U     U::::::UP::::::::::::::::P  
//  S:::::SSSSSS::::::SE::::::::::::::::::::ET:::::::::::::::::::::TU::::::U     U::::::UP::::::PPPPPP:::::P 
//  S:::::S     SSSSSSSEE::::::EEEEEEEEE::::ET:::::TT:::::::TT:::::TUU:::::U     U:::::UUPP:::::P     P:::::P
//  S:::::S              E:::::E       EEEEEETTTTTT  T:::::T  TTTTTT U:::::U     U:::::U   P::::P     P:::::P
//  S:::::S              E:::::E                     T:::::T         U:::::D     D:::::U   P::::P     P:::::P
//   S::::SSSS           E::::::EEEEEEEEEE           T:::::T         U:::::D     D:::::U   P::::PPPPPP:::::P 
//    SS::::::SSSSS      E:::::::::::::::E           T:::::T         U:::::D     D:::::U   P:::::::::::::PP  
//      SSS::::::::SS    E:::::::::::::::E           T:::::T         U:::::D     D:::::U   P::::PPPPPPPPP    
//         SSSSSS::::S   E::::::EEEEEEEEEE           T:::::T         U:::::D     D:::::U   P::::P            
//              S:::::S  E:::::E                     T:::::T         U:::::D     D:::::U   P::::P            
//              S:::::S  E:::::E       EEEEEE        T:::::T         U::::::U   U::::::U   P::::P            
//  SSSSSSS     S:::::SEE::::::EEEEEEEE:::::E      TT:::::::TT       U:::::::UUU:::::::U PP::::::PP          
//  S::::::SSSSSS:::::SE::::::::::::::::::::E      T:::::::::T        UU:::::::::::::UU  P::::::::P          
//  S:::::::::::::::SS E::::::::::::::::::::E      T:::::::::T          UU:::::::::UU    P::::::::P          
//   SSSSSSSSSSSSSSS   EEEEEEEEEEEEEEEEEEEEEE      TTTTTTTTTTT            UUUUUUUUU      PPPPPPPPPP   

void setup()
{
  // SERIAL TERMINAL SETUP
  // ---------------------
  //Serial.begin(115200);



   // PRINT SENSOR VALUES TO SERIAL MONITOR
  // -------------------------------------

  //for (byte y = 0; y < 5; y++) // CYCLE THROUGH RIGHT Y-AXIS SENSORS
  //{
  //  Serial.print(y);
  //  Serial.print(": ");
  //  Serial.print(capAxisPercent[y]);
  //  Serial.println();
  //}





  // PIN CONFIGURATION
	// -----------------
	pinMode(switchInput[0], INPUT);
  pinMode(switchInput[1], INPUT);
  pinMode(switchInput[2], INPUT);
  pinMode(switchInput[3], INPUT);
  pinMode(switchInput[4], INPUT);
  pinMode(switchInput[5], INPUT);
  pinMode(switchInput[6], INPUT);
  pinMode(switchInput[7], INPUT);
  pinMode(switchInput[8], INPUT);
  pinMode(switchInput[9], INPUT);

  pinMode(switchResistor[0], OUTPUT);
  pinMode(switchResistor[1], OUTPUT);
  pinMode(switchResistor[2], OUTPUT);
  pinMode(switchResistor[3], OUTPUT);
  pinMode(switchResistor[4], OUTPUT);
  pinMode(switchResistor[5], OUTPUT);
  pinMode(switchResistor[6], OUTPUT);
  pinMode(switchResistor[7], OUTPUT);
  pinMode(switchResistor[8], OUTPUT);
  pinMode(switchResistor[9], OUTPUT);

  digitalWrite(switchResistor[0], 0);
  digitalWrite(switchResistor[1], 0);
  digitalWrite(switchResistor[2], 0);
  digitalWrite(switchResistor[3], 0);
  digitalWrite(switchResistor[4], 0);
  digitalWrite(switchResistor[5], 0);
  digitalWrite(switchResistor[6], 0);
  digitalWrite(switchResistor[7], 0);
  digitalWrite(switchResistor[8], 0);
  digitalWrite(switchResistor[9], 0);


  pinMode(axisInput[0], INPUT);
  pinMode(axisInput[1], INPUT);
  pinMode(axisInput[2], INPUT);
  pinMode(axisInput[3], INPUT);
  pinMode(axisInput[4], INPUT);
  pinMode(axisInput[5], INPUT);
  pinMode(axisInput[6], INPUT);
  pinMode(axisInput[7], INPUT);
  pinMode(axisInput[8], INPUT);
  pinMode(axisInput[9], INPUT);

  pinMode(axisResistor[0], OUTPUT);
  pinMode(axisResistor[1], OUTPUT);
  pinMode(axisResistor[2], OUTPUT);
  pinMode(axisResistor[3], OUTPUT);
  pinMode(axisResistor[4], OUTPUT);
  pinMode(axisResistor[5], OUTPUT);
  pinMode(axisResistor[6], OUTPUT);
  pinMode(axisResistor[7], OUTPUT);
  pinMode(axisResistor[8], OUTPUT);
  pinMode(axisResistor[9], OUTPUT);

  digitalWrite(axisResistor[0], 0);
  digitalWrite(axisResistor[1], 0);
  digitalWrite(axisResistor[2], 0);
  digitalWrite(axisResistor[3], 0);
  digitalWrite(axisResistor[4], 0);
  digitalWrite(axisResistor[5], 0);
  digitalWrite(axisResistor[6], 0);
  digitalWrite(axisResistor[7], 0);
  digitalWrite(axisResistor[8], 0);
  digitalWrite(axisResistor[9], 0);


  pinMode(channelOutput[0], OUTPUT);
  pinMode(channelOutput[1], OUTPUT);
  pinMode(channelOutput[2], OUTPUT);
  pinMode(channelOutput[3], OUTPUT);
  pinMode(channelOutput[4], OUTPUT);
  pinMode(channelOutput[5], OUTPUT);
  pinMode(channelOutput[6], OUTPUT);
  pinMode(channelOutput[7], OUTPUT);
  pinMode(channelOutput[8], OUTPUT);
  pinMode(channelOutput[9], OUTPUT);

	digitalWrite(channelOutput[0], 0);
  digitalWrite(channelOutput[1], 0);
  digitalWrite(channelOutput[2], 0);
  digitalWrite(channelOutput[3], 0);
  digitalWrite(channelOutput[4], 0);
  digitalWrite(channelOutput[5], 0);
  digitalWrite(channelOutput[6], 0);
  digitalWrite(channelOutput[7], 0);
  digitalWrite(channelOutput[8], 0);
  digitalWrite(channelOutput[9], 0);

  pinMode(axisOutput[0], OUTPUT);
  pinMode(axisOutput[1], OUTPUT);
  pinMode(axisOutput[2], OUTPUT);

  analogWrite(axisOutput[0], 0);
  analogWrite(axisOutput[1], 0);
  analogWrite(axisOutput[2], 0);

  pinMode(clockInput, INPUT);

  pinMode(resetInput, INPUT);
  pinMode(scanInput, INPUT);

  pinMode(monoButton, INPUT);
  pinMode(restButton, INPUT);
  pinMode(duoButton, INPUT);

  pinMode(gateOutputLeft, OUTPUT);
  pinMode(gateOutputRight, OUTPUT);
  pinMode(gateOutputAll, OUTPUT);

  digitalWrite(gateOutputLeft, 0);
  digitalWrite(gateOutputRight, 0);
  digitalWrite(gateOutputAll, 0);

  pinMode(allSelectorA, OUTPUT);
  pinMode(allSelectorB, OUTPUT);
  pinMode(allSelectorC, OUTPUT);
  pinMode(allSelectorD, OUTPUT);

  digitalWrite(allSelectorA, 1);
  digitalWrite(allSelectorB, 1);
  digitalWrite(allSelectorC, 1);
  digitalWrite(allSelectorD, 1);

  analogReadResolution(12);




  // CAPACITIVE CALIBRATION
  // ------------------------------
  for (byte y = 0; y < 10; y++)
  {
    capSwitch[y].set_CS_Timeout_Millis(1000);
    capAxis[y].set_CS_Timeout_Millis(1000);

    capSwitch[y].set_CS_AutocaL_Millis(0xFFFFFFFF);
    //capSwitch[y].set_CS_AutocaL_Millis(1000);

    //capAxis[y].set_CS_AutocaL_Millis(0xFFFFFFFF);
    capAxis[y].set_CS_AutocaL_Millis(20000);
  }

  attachInterrupt(clockInput, clockInterrupted, RISING);
  attachInterrupt(resetInput, resetInterrupted, RISING);

  lastCapSwitchTimerLeft = millis();
  lastCapSwitchTimerRight = millis();

  for (byte y = 0; y < 10; y++)
  {
    delay(200);
    capSwitch[y].reset_CS_AutoCal();
    capAxis[y].reset_CS_AutoCal();
  }
}





// -------------------------------------------------------------------------------------------------------------------------------------------------------
// -------------------------------------------------------------------------------------------------------------------------------------------------------
// -------------------------------------------------------------------------------------------------------------------------------------------------------





//  MMMMMMMM               MMMMMMMM               AAA               IIIIIIIIIINNNNNNNN        NNNNNNNN
//  M:::::::M             M:::::::M              A:::A              I::::::::IN:::::::N       N::::::N
//  M::::::::M           M::::::::M             A:::::A             I::::::::IN::::::::N      N::::::N
//  M:::::::::M         M:::::::::M            A:::::::A            II::::::IIN:::::::::N     N::::::N
//  M::::::::::M       M::::::::::M           A:::::::::A             I::::I  N::::::::::N    N::::::N
//  M:::::::::::M     M:::::::::::M          A:::::A:::::A            I::::I  N:::::::::::N   N::::::N
//  M:::::::M::::M   M::::M:::::::M         A:::::A A:::::A           I::::I  N:::::::N::::N  N::::::N
//  M::::::M M::::M M::::M M::::::M        A:::::A   A:::::A          I::::I  N::::::N N::::N N::::::N
//  M::::::M  M::::M::::M  M::::::M       A:::::A     A:::::A         I::::I  N::::::N  N::::N:::::::N
//  M::::::M   M:::::::M   M::::::M      A:::::AAAAAAAAA:::::A        I::::I  N::::::N   N:::::::::::N
//  M::::::M    M:::::M    M::::::M     A:::::::::::::::::::::A       I::::I  N::::::N    N::::::::::N
//  M::::::M     MMMMM     M::::::M    A:::::AAAAAAAAAAAAA:::::A      I::::I  N::::::N     N:::::::::N
//  M::::::M               M::::::M   A:::::A             A:::::A   II::::::IIN::::::N      N::::::::N
//  M::::::M               M::::::M  A:::::A               A:::::A  I::::::::IN::::::N       N:::::::N
//  M::::::M               M::::::M A:::::A                 A:::::A I::::::::IN::::::N        N::::::N
//  MMMMMMMM               MMMMMMMMAAAAAAA                   AAAAAAAIIIIIIIIIINNNNNNNN         NNNNNNN





void loop()
{
  stepClock();

  checkCapSwitchLeft(0);
  checkCapSwitchRight(0);

  stepClock();
  pressMonoButton();

  checkCapSwitchLeft(1);
  checkCapSwitchRight(1);

  stepClock();
  pressRestButton();

  checkCapSwitchLeft(2);
  checkCapSwitchRight(2);

  stepClock();
  pressDuoButton();

  checkCapSwitchLeft(3);
  checkCapSwitchRight(3);

  stepClock();
  checkScan();

  checkCapSwitchLeft(4);
  checkCapSwitchRight(4);
}





// -------------------------------------------------------------------------------------------------------------------------------------------------------
// -------------------------------------------------------------------------------------------------------------------------------------------------------
// -------------------------------------------------------------------------------------------------------------------------------------------------------